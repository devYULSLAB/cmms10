<!DOCTYPE html>
<!--
íŒ¨í‚¤ì§€: com.cmms10.workPermit
íŒŒì¼: workPermitDetail.html
ì£¼ìš”ê¸°ëŠ¥: ì‘ì—…í—ˆê°€ì„œ ìƒì„¸ì •ë³´ ì¶œë ¥ ë° í”„ë¦°íŠ¸ í¼
ìƒì„±ì: (ë¡œê·¸ì¸ ì´ë¦„ ì…ë ¥)
ìƒì„±ì¼: (ìƒì„±ì¼ ì…ë ¥)
-->
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/defaultLayout}">

<head>
    <title>ì‘ì—…í—ˆê°€ì„œ ìƒì„¸</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="max-w-4xl mx-auto mt-8 space-y-6">
            <h2 class="text-2xl font-bold" th:text="#{workpermitDetail}">ì‘ì—…í—ˆê°€ì„œ ìƒì„¸</h2>

            <!-- Basic Information -->
            <div class="border rounded-lg shadow p-4 space-y-4">
                <h3 class="font-semibold text-lg mb-2" th:text="#{basicInformation}">ê¸°ë³¸ ì •ë³´</h3>
                <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1" th:text="#{permitId}">Permit ID</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${workpermit.permitId}"></div>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1" th:text="#{plantId}">Plant ID</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${workpermit.plantId}"></div>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium mb-1" th:text="#{permitType}">Permit Type</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${workpermit.permitType}"></div>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium mb-1" th:text="#{siteId}">Site</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${workpermit.siteId}"></div>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium mb-1" th:text="#{deptId}">Dept</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${workpermit.deptId}"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1" th:text="#{permitName}">Permit Name</label>
                    <div class="p-2 bg-gray-50 rounded" th:text="${workpermit.permitName}"></div>
                </div>
            </div>

            <!-- Permit Period -->
            <div class="border rounded-lg shadow p-4 space-y-4">
                <h3 class="font-semibold text-lg mb-2" th:text="#{permitPeriod}">Permit Period</h3>
                <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1" th:text="#{startDate}">Start Date</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${workpermit.startDate}"></div>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1" th:text="#{endDate}">End Date</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${workpermit.endDate}"></div>
                    </div>
                </div>
            </div>

            <!-- Permit Description -->
            <div class="border rounded-lg shadow p-4 space-y-4">
                <h3 class="font-semibold text-lg mb-2" th:text="#{permitDescription}">Permit Description</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1" th:text="#{workDesc}">Work Description</label>
                        <div class="p-2 bg-gray-50 rounded min-h-[60px]" th:text="${workpermit.workDesc}"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" th:text="#{hazardNote}">Hazard Note</label>
                        <div class="p-2 bg-gray-50 rounded min-h-[60px]" th:text="${workpermit.hazardNote}"></div>
                    </div>
                </div>
            </div>

            <!-- Permit Safety Measures -->
            <div class="border rounded-lg shadow p-4 space-y-4">
                <h3 class="font-semibold text-lg mb-2" th:text="#{safetyMeasures}">Permit Safety Measures</h3>
                <div>
                    <label class="block text-sm font-medium mb-1" th:text="#{safetyMeasure}">Safety Measure</label>
                    <div class="p-2 bg-gray-50 rounded min-h-[60px]" th:text="${workpermit.safetyMeasure}"></div>
                </div>
            </div>

            <!-- Permit Signatures -->
            <div class="border rounded-lg shadow p-4 space-y-4">
                <h3 class="font-semibold text-lg mb-2" th:text="#{signature}">Permit Signatures</h3>
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 border text-left">Signer Name</th>
                            <th class="px-4 py-2 border text-left">Signature</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item : ${workpermit.items}" class="hover:bg-gray-50">
                            <td class="px-4 py-2 border" th:text="${item.signerName}"></td>
                            <td class="px-4 py-2 border">
                                <!-- ì„œëª… ì´ë¯¸ì§€ í‘œì‹œ -->
                                <img th:if="${item.signature != null and item.signature != ''}"
                                    th:src="${item.signature}" alt="Signature"
                                    class="max-w-[200px] max-h-[100px] border rounded" />
                                <span th:if="${item.signature == null or item.signature == ''}"
                                    class="text-gray-500 italic">ì„œëª… ì—†ìŒ</span>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(workpermit.items)}">
                            <td colspan="2" class="px-4 py-2 border text-center text-gray-500">ë“±ë¡ëœ ì„œëª…ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Checksheet ê²°ê³¼ ë Œë”ë§ -->
            <div th:if="${checkResultJson != null and checkResultJson != ''}"
                class="border rounded-lg shadow p-4 space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold text-lg">ğŸ§¾ ì²´í¬ì‹œíŠ¸ ê²°ê³¼</h3>
                    <a th:href="@{/checksheet/checksheetResultDetail/{permitId}(permitId=${workpermit.permitId})}"
                        class="inline-flex items-center px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                        <i class="fas fa-external-link-alt mr-1"></i>ìƒì„¸ë³´ê¸°
                    </a>
                </div>
                <div id="checksheetView" class="p-4 bg-gray-50 rounded border"></div>
            </div>
            <!-- Buttons -->
            <div class="flex space-x-4 mt-6 non-print-section">
                <a th:href="@{/workpermit/workpermitList}"
                    class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600" th:text="#{cancel}">ì·¨ì†Œ</a>
                <button onclick="printContent()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    <i class="fas fa-print mr-1"></i><span>ì¶œë ¥</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Print Container (ì²´í¬ì‹œíŠ¸ ì œì™¸, ì„œëª…ê¹Œì§€ í¬í•¨) -->
    <div id="printContainer" style="display: none;">
        <div class="max-w-4xl mx-auto p-6">
            <h2 class="text-2xl font-bold mb-6 text-center">ì‘ì—…í—ˆê°€ì„œ</h2>

            <!-- Basic Info -->
            <div class="border rounded-lg p-4 space-y-4 mb-6">
                <h3 class="font-semibold text-lg mb-2">ê¸°ë³¸ ì •ë³´</h3>
                <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1">í—ˆê°€ ID</label>
                        <div th:text="${workpermit.permitId}">-</div>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1">ì„¤ë¹„</label>
                        <div th:text="${workpermit.plantId}">-</div>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium mb-1">í—ˆê°€ ìœ í˜•</label>
                        <div th:text="${workpermit.permitType}">-</div>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium mb-1">ì‚¬ì´íŠ¸</label>
                        <div th:text="${workpermit.siteId}">-</div>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium mb-1">ë¶€ì„œ</label>
                        <div th:text="${workpermit.deptId}">-</div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 mt-4">í—ˆê°€ëª…</label>
                    <div th:text="${workpermit.permitName}">-</div>
                </div>
            </div>

            <!-- Permit Period -->
            <div class="border rounded-lg p-4 space-y-4 mb-6">
                <h3 class="font-semibold text-lg mb-2">í—ˆê°€ ê¸°ê°„</h3>
                <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1">ì‹œì‘ì¼</label>
                        <div th:text="${workpermit.startDate}">-</div>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1">ì¢…ë£Œì¼</label>
                        <div th:text="${workpermit.endDate}">-</div>
                    </div>
                </div>
            </div>

            <!-- Permit Description -->
            <div class="border rounded-lg p-4 space-y-4 mb-6">
                <h3 class="font-semibold text-lg mb-2">í—ˆê°€ ì„¤ëª…</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">ì‘ì—… ì„¤ëª…</label>
                        <div th:text="${workpermit.workDesc}">-</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ìœ„í—˜ ìš”ì†Œ</label>
                        <div th:text="${workpermit.hazardNote}">-</div>
                    </div>
                </div>
            </div>

            <!-- Permit Safety Measures -->
            <div class="border rounded-lg p-4 space-y-4 mb-6">
                <h3 class="font-semibold text-lg mb-2">ì•ˆì „ ì¡°ì¹˜ì‚¬í•­</h3>
                <div>
                    <label class="block text-sm font-medium mb-1">ì•ˆì „ ì¡°ì¹˜</label>
                    <div th:text="${workpermit.safetyMeasure}">-</div>
                </div>
            </div>

            <!-- Permit Signatures -->
            <div class="border rounded-lg p-4 space-y-4 mb-6">
                <h3 class="font-semibold text-lg mb-2">ì„œëª…</h3>
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 border text-left">ìˆœì„œ</th>
                            <th class="px-4 py-2 border text-left">ì„œëª…ìëª…</th>
                            <th class="px-4 py-2 border text-left">ì„œëª…</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item, iterStat : ${workpermit.items}" class="signer-row">
                            <td class="px-4 py-2 border text-center" th:text="${iterStat.count}"></td>
                            <td class="px-4 py-2 border" th:text="${item.signerName}"></td>
                            <td class="px-4 py-2 border">
                                <div class="flex items-center space-x-2">
                                    <img th:if="${item.signature && item.signature.trim() != ''}"
                                        th:src="${item.signature}" alt="ì„œëª…"
                                        style="max-width: 200px; max-height: 60px; object-fit: contain;" />
                                    <span th:if="${!item.signature || item.signature.trim() == ''}"
                                        class="text-gray-400">ì„œëª… ì—†ìŒ</span>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(workpermit.items)}">
                            <td class="border px-4 py-2 text-center" colspan="3">ì„œëª…ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Footer -->
            <div class="text-center text-sm text-gray-600 mt-8">
                <p>ì¶œë ¥ì¼ì‹œ: <span th:text="${#dates.format(#dates.createNow(), 'yyyy-MM-dd HH:mm')}">-</span></p>
            </div>
        </div>
    </div>

    <th:block layout:fragment="page-js">
        <!-- formRender.js ì‚½ì… -->
        <script src="https://formbuilder.online/assets/js/form-render.min.js"></script>
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function () {
                const resultJson = /*[[${checkResultJson}]]*/ null;
                const templateJson = /*[[${templateJson}]]*/ null;
                console.log('ì²´í¬ì‹œíŠ¸ ê²°ê³¼ JSON:', resultJson);
                console.log('í…œí”Œë¦¿ JSON:', templateJson);

                if (resultJson && resultJson !== '' && resultJson !== '{}') {
                    try {
                        const formData = typeof resultJson === 'string' ? JSON.parse(resultJson) : resultJson;
                        console.log('íŒŒì‹±ëœ í¼ ë°ì´í„°:', formData);

                        if (formData && Object.keys(formData).length > 0) {
                            // formRenderë¡œ ì²´í¬ì‹œíŠ¸ ë Œë”ë§
                            $('#checksheetView').formRender({
                                formData: templateJson || formData, // í…œí”Œë¦¿ì´ ìˆìœ¼ë©´ í…œí”Œë¦¿ ì‚¬ìš©, ì—†ìœ¼ë©´ ê²°ê³¼ ë°ì´í„° ì‚¬ìš©
                                readOnly: true,
                                i18n: false
                            });

                            // ë Œë”ë§ ì™„ë£Œ í›„ ë°ì´í„° ë³µì›
                            setTimeout(() => {
                                restoreCheckResultData(formData);
                            }, 100);

                            console.log('ì²´í¬ì‹œíŠ¸ ë Œë”ë§ ì™„ë£Œ');
                        } else {
                            document.getElementById('checksheetView').innerHTML =
                                '<p class="text-gray-500 text-center py-8">ì²´í¬ì‹œíŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        }
                    } catch (e) {
                        console.error('ì²´í¬ì‹œíŠ¸ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                        document.getElementById('checksheetView').innerHTML =
                            '<p class="text-red-500 text-center py-8">ì²´í¬ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                } else {
                    document.getElementById('checksheetView').innerHTML =
                        '<p class="text-gray-500 text-center py-8">ì²´í¬ì‹œíŠ¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            });

            // ì²´í¬ì‹œíŠ¸ ë°ì´í„° ë³µì› í•¨ìˆ˜
            function restoreCheckResultData(savedData) {
                if (!savedData || Object.keys(savedData).length === 0) {
                    return;
                }

                try {
                    console.log('ë³µì›í•  ì²´í¬ì‹œíŠ¸ ë°ì´í„°:', savedData);

                    // formRender ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
                    const formRenderInstance = $('#checksheetView').data('formRender');

                    if (formRenderInstance && typeof formRenderInstance.setData === 'function') {
                        // formRenderì˜ setData ë©”ì„œë“œë¡œ ë°ì´í„° ë³µì›
                        formRenderInstance.setData(savedData);
                        console.log('formRender setDataë¡œ ë°ì´í„° ë³µì› ì™„ë£Œ');
                    } else {
                        // setDataê°€ ì—†ìœ¼ë©´ ì§ì ‘ í¼ ìš”ì†Œì— ê°’ ì„¤ì •
                        restoreFormDataDirectly(savedData);
                        console.log('ì§ì ‘ ë³µì›ìœ¼ë¡œ ë°ì´í„° ë³µì› ì™„ë£Œ');
                    }
                } catch (error) {
                    console.error('ì²´í¬ì‹œíŠ¸ ë°ì´í„° ë³µì› ì‹¤íŒ¨:', error);
                    // fallback: ì§ì ‘ ë³µì›
                    restoreFormDataDirectly(savedData);
                }
            }

            // í¼ ìš”ì†Œì— ì§ì ‘ ë°ì´í„° ë³µì› (fallbackìš©)
            function restoreFormDataDirectly(savedData) {
                const formElements = document.querySelectorAll('#checksheetView input, #checksheetView select, #checksheetView textarea');

                formElements.forEach((element) => {
                    if (element.name && savedData[element.name] !== undefined) {
                        if (element.type === 'checkbox') {
                            element.checked = savedData[element.name];
                        } else {
                            element.value = savedData[element.name];
                        }
                    }
                });
            }

            // ì¸ì‡„ ê¸°ëŠ¥
            function printContent() {
                const printContainer = document.getElementById('printContainer');
                const originalDisplay = printContainer.style.display;

                // Print containerë¥¼ ë³´ì´ê²Œ ì„¤ì •
                printContainer.style.display = 'block';

                // í˜„ì¬ í˜ì´ì§€ì˜ ìŠ¤íƒ€ì¼ì„ ì €ì¥
                const originalBodyStyle = document.body.style.cssText;

                // Print containerë§Œ ë³´ì´ë„ë¡ body ìŠ¤íƒ€ì¼ ë³€ê²½
                document.body.innerHTML = printContainer.innerHTML;
                document.body.style.cssText = 'margin: 0; padding: 20px; font-family: Arial, sans-serif;';

                // ì¸ì‡„ ì‹¤í–‰
                window.print();

                // ì›ë˜ í˜ì´ì§€ë¡œ ë³µì›
                window.location.reload();
            }
        </script>
    </th:block>
</body>

</html>