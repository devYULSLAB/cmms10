<!-- workPermitForm.html -->
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/defaultLayout}">

<head>
    <title>ì‘ì—…í—ˆê°€ì„œ ë“±ë¡</title>
</head>


<body>
    <div layout:fragment="content">
        <div class="max-w-4xl mx-auto mt-8 space-y-6">
            <h2 class="text-2xl font-bold"
                th:text="${workpermit.permitId == null ? 'ì‘ì—…í—ˆê°€ì„œ ì‹ ê·œ' : 'ì‘ì—…í—ˆê°€ì„œ ìˆ˜ì •: ' + workpermit.permitId}">ì‘ì—…í—ˆê°€ì„œ ë“±ë¡</h2>
            <!-- Alerts -->
            <div th:if="${successMessage}" class="p-3 bg-green-100 text-green-800 rounded">
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="p-3 bg-red-100 text-red-800 rounded">
                <span th:text="${errorMessage}"></span>
            </div>

            <form th:action="@{/workpermit/workpermitSave}" method="post" th:object="${workpermit}" class="space-y-6"
                onsubmit="return saveSignature()">
                <!-- Hidden fields -->
                <input type="hidden" th:field="*{companyId}" />
                <input type="hidden" th:field="*{createBy}" />
                <input type="hidden" th:field="*{createDate}" />
                <input type="hidden" th:field="*{updateBy}" />
                <input type="hidden" th:field="*{updateDate}" />

                <!-- Basic Info -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2" th:text="#{basicInformation}">Basic Information</h3>
                    <div class="grid grid-cols-12 gap-4">
                        <div class="col-span-3">
                            <label class="block text-sm font-medium mb-1" th:text="#{permitId}">Permit ID</label>
                            <input type="text" th:field="*{permitId}"
                                class="w-full border rounded px-2 py-1 bg-gray-100" readonly />
                        </div>
                        <div class="col-span-3">
                            <label class="block text-sm font-medium mb-1" th:text="#{plantId}">Plant ID</label>
                            <input type="text" th:field="*{plantId}" class="w-full border rounded px-2 py-1" />
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1" th:text="#{permitType}">Permit Type</label>
                            <select th:field="*{permitType}" class="w-full border rounded px-2 py-1">
                                <option value="">-- í—ˆê°€ ìœ í˜• ì„ íƒ --</option>
                                <option th:each="permitType : ${permitTypes}" th:value="${permitType.codeId}"
                                    th:text="${permitType.codeId + ' - ' + permitType.codeName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1" th:text="#{siteId}">Site</label>
                            <select id="siteId" th:field="*{siteId}" class="w-full border rounded px-2 py-1">
                                <option value="">-- Site ì„ íƒ --</option>
                                <option th:each="site : ${sites}" th:value="${site.siteId}"
                                    th:text="${site.siteId + ' - ' + site.siteName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1" th:text="#{deptId}">Dept</label>
                            <select th:field="*{deptId}" class="w-full border rounded px-2 py-1">
                                <option value="">-- ë¶€ì„œ ì„ íƒ --</option>
                                <option th:each="dept : ${depts}" th:value="${dept.deptId}"
                                    th:text="${dept.deptId + ' - ' + dept.deptName}">
                                </option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" th:text="#{permitName}">Permit Name</label>
                        <input type="text" th:field="*{permitName}" class="w-full border rounded px-2 py-1" />
                    </div>
                </div>
                <!-- Permit Period -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2" th:text="#{permitPeriod}">Permit Period</h3>
                    <div class="grid grid-cols-12 gap-4">
                        <div class="col-span-3">
                            <label class="block text-sm font-medium mb-1" th:text="#{startDate}">Start Date</label>
                            <input type="date" th:field="*{startDate}" class="w-full border rounded px-2 py-1" />
                        </div>
                        <div class="col-span-3">
                            <label class="block text-sm font-medium mb-1" th:text="#{endDate}">End Date</label>
                            <input type="date" th:field="*{endDate}" class="w-full border rounded px-2 py-1" />
                        </div>
                    </div>
                </div>

                <!-- Permit Description -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2" th:text="#{permitDescription}">Permit Description</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{workDesc}">Work Description</label>
                            <textarea th:field="*{workDesc}" rows="3"
                                class="w-full border rounded px-2 py-1"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{hazardNote}">Hazard Note</label>
                            <textarea th:field="*{hazardNote}" rows="3"
                                class="w-full border rounded px-2 py-1"></textarea>
                        </div>
                    </div>
                </div>
                <!-- Permit Safety Measures -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2" th:text="#{safetyMeasures}">Permit Safety Measures</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{safetyMeasure}">Safety
                                Measure</label>
                            <textarea th:field="*{safetyMeasure}" rows="3"
                                class="w-full border rounded px-2 py-1"></textarea>
                        </div>
                    </div>
                </div>
                <!-- Permit Signatures items-->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-semibold text-lg mb-2" th:text="#{signature}">Permit Signatures</h3>
                        <button type="button" onclick="addSigner()"
                            class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                            <i class="fas fa-plus mr-1"></i>ì„œëª…ì ì¶”ê°€
                        </button>
                    </div>
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 border text-left">ìˆœì„œ</th>
                                <th class="px-4 py-2 border text-left">ì„œëª…ìëª…</th>
                                <th class="px-4 py-2 border text-left">ì„œëª…</th>
                                <th class="px-4 py-2 border text-left">ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody id="itemTableBody">
                            <tr th:each="item, iterStat : *{items}" class="signer-row">
                                <td class="px-4 py-2 border text-center">
                                    <span class="signer-order" th:text="${iterStat.count}"></span>
                                </td>
                                <td class="px-4 py-2 border">
                                    <input type="text" th:field="*{items[__${iterStat.index}__].signerName}"
                                        class="w-full border rounded px-2 py-1"
                                        th:placeholder="'ì„œëª…ì ' + ${iterStat.count} + 'ëª…'" required />
                                </td>
                                <td class="px-4 py-2 border">
                                    <div class="flex items-center space-x-2">
                                        <canvas th:attr="id='signatureCanvas' + ${iterStat.index}" width="250"
                                            height="80"
                                            style="border:1px solid #ccc; border-radius: 4px; cursor: crosshair;"
                                            class="signature-canvas"></canvas>
                                        <input type="hidden" th:field="*{items[__${iterStat.index}__].signature}"
                                            th:attr="id='signatureData' + ${iterStat.index}"
                                            th:name="items[__${iterStat.index}__].signature" />
                                    </div>
                                </td>
                                <td class="px-4 py-2 border">
                                    <div class="flex space-x-1">
                                        <button type="button"
                                            th:attr="onclick='clearSignature(' + ${iterStat.index} + ')'"
                                            class="px-2 py-1 text-blue-600 border border-blue-500 rounded hover:bg-blue-50 text-xs">
                                            ì§€ìš°ê¸°
                                        </button>
                                        <button type="button"
                                            th:attr="onclick='removeSigner(' + ${iterStat.index} + ')'"
                                            class="px-2 py-1 text-red-600 border border-red-500 rounded hover:bg-red-50 text-xs">
                                            ì‚­ì œ
                                        </button>
                                    </div>
                                </td>
                            </tr>

                        </tbody>
                    </table>
                    <div class="text-sm text-gray-600 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        ìµœì†Œ 1ëª…ì˜ ì„œëª…ìê°€ í•„ìš”í•©ë‹ˆë‹¤. ì„œëª…ìëŠ” ìˆœì„œëŒ€ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.
                    </div>
                </div>

                <!-- ì²´í¬ì‹œíŠ¸ í…œí”Œë¦¿ ì„ íƒ -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2">ğŸ§¾ ì•ˆì „ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
                    <div class="mb-2">
                        <label class="block text-sm font-medium mb-1">í…œí”Œë¦¿ ì„ íƒ</label>
                        <select id="templateSelect" class="w-full border rounded p-2">
                            <option value="">-- í…œí”Œë¦¿ ì„ íƒ --</option>
                            <option th:each="tpl : ${templateList}" th:value="${tpl.templateId}"
                                th:text="${tpl.templateName}">
                            </option>
                        </select>
                        <!-- templateIdë¥¼ ì„œë²„ë¡œ ì „ì†¡í•˜ê¸° ìœ„í•œ hidden í•„ë“œ ì¶”ê°€ -->
                        <input type="hidden" id="templateIdHidden" name="templateId" />
                    </div>

                    <!-- formRender.jsë¡œ í…œí”Œë¦¿ í‘œì‹œ -->
                    <div id="form-render" class="border rounded p-4 bg-gray-50 min-h-[200px]">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-clipboard-list text-2xl mb-2"></i>
                            <p>í…œí”Œë¦¿ì„ ì„ íƒí•˜ë©´ ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <!-- ì²´í¬ ê²°ê³¼ ì €ì¥ìš© -->
                    <!-- <input type="hidden" id="checkResultJson" name="checkResultJson" /> -->
                    <textarea id="checkResultJson" name="checkResultJson" hidden></textarea>
                </div>

                <!-- Submit Button -->
                <div class="flex gap-3 justify-end">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                        th:text="#{save}">ì €ì¥ </button>
                </div>
            </form>
        </div>
    </div>
    <th:block layout:fragment="page-js">
        <!-- ì²´í¬ì‹œíŠ¸ ë Œë”ë§ìš© formRender.js -->
        <script src="https://formbuilder.online/assets/js/form-render.min.js"></script>
        <script th:inline="javascript">
            // DOM ë¡œë“œ í›„ ì‹¤í–‰
            document.addEventListener('DOMContentLoaded', function () {
                // âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ í…œí”Œë¦¿ ë Œë”ë§
                const templateJsonMap = /*[[${templateJsonMap}]]*/ {};
                window.renderInstance = null; // Global variable

                const templateSelect = document.getElementById('templateSelect');
                const formRender = document.getElementById('form-render');

                if (templateSelect) {
                    templateSelect.addEventListener('change', function () {
                        const tplId = this.value;
                        const json = templateJsonMap[tplId];

                        if (json && window.$ && window.$.fn.formRender) {
                            // Remove existing form
                            $('#form-render').empty();
                            // Render new form
                            $('#form-render').formRender({
                                formData: json,
                                readOnly: false,
                                i18n: false
                            });
                            window.renderInstance = $('#form-render').data('formRender');

                            // templateId hidden í•„ë“œì— ê°’ ì„¤ì •
                            document.getElementById("templateIdHidden").value = tplId;

                            // Initialize check result field
                            document.getElementById("checkResultJson").value = "{}";

                            // ê¸°ì¡´ ì²´í¬ì‹œíŠ¸ ë°ì´í„° ë³µì›
                            setTimeout(() => {
                                restoreCheckResultData();
                            }, 100);
                        } else if (!tplId) {
                            // Template not selected
                            $('#form-render').html(`
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-clipboard-list text-2xl mb-2"></i>
                                    <p>Select a template to display checklist.</p>
                                </div>
                            `);
                            window.renderInstance = null;
                            // templateId hidden í•„ë“œ ì´ˆê¸°í™”
                            document.getElementById("templateIdHidden").value = "";
                            document.getElementById("checkResultJson").value = "{}";
                        } else {
                            $('#form-render').html(`
                                <div class="text-center text-red-500 py-8">
                                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                    <p>Cannot load template.</p>
                                </div>
                            `);
                            window.renderInstance = null;
                            document.getElementById("checkResultJson").value = "{}";
                        }
                    });
                }

                // âœ… canvas ì„œëª… ì…ë ¥ ê¸°ëŠ¥ (ì—¬ëŸ¬ ê°œ ì§€ì›) ë° ê¸°ì¡´ ì„œëª… ì´ë¯¸ì§€ ë¡œë“œ
                const canvases = document.querySelectorAll('canvas[id^="signatureCanvas"]');
                canvases.forEach(function (canvas, index) {
                    let drawing = false;
                    let ctx = canvas.getContext('2d');

                    // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';

                    let lastX = 0, lastY = 0;

                    // ê¸°ì¡´ ì„œëª… ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                    const signatureData = document.getElementById('signatureData' + index);
                    if (signatureData && signatureData.value && signatureData.value.trim() !== '') {
                        const img = new Image();
                        img.onload = function () {
                            // ìº”ë²„ìŠ¤ í¬ê¸°ì— ë§ê²Œ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        };
                        img.src = signatureData.value;
                    }

                    function getXY(e) {
                        if (e.touches) {
                            const rect = canvas.getBoundingClientRect();
                            return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
                        } else {
                            return [e.offsetX, e.offsetY];
                        }
                    }

                    canvas.addEventListener('mousedown', function (e) {
                        drawing = true;
                        [lastX, lastY] = getXY(e);
                    });
                    canvas.addEventListener('mousemove', function (e) {
                        if (!drawing) return;
                        const [x, y] = getXY(e);
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        [lastX, lastY] = [x, y];
                    });
                    canvas.addEventListener('mouseup', function () { drawing = false; });
                    canvas.addEventListener('mouseout', function () { drawing = false; });
                    canvas.addEventListener('touchstart', function (e) {
                        drawing = true;
                        [lastX, lastY] = getXY(e);
                    });
                    canvas.addEventListener('touchmove', function (e) {
                        if (!drawing) return;
                        const [x, y] = getXY(e);
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        [lastX, lastY] = [x, y];
                        e.preventDefault();
                    }, { passive: false });
                    canvas.addEventListener('touchend', function () { drawing = false; });
                });

                // âœ… í¼ ì œì¶œ ì‹œ saveSignature() í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬
                // document.querySelector("form").addEventListener("submit", function (e) {
                //     // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë°œìƒ
                // });

                // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ì²´í¬ì‹œíŠ¸ ë°ì´í„° ë³µì› (ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš°)
                setTimeout(() => {
                    restoreCheckResultData();
                }, 500);
            });

            // í¼ ì œì¶œ ì‹œ í˜¸ì¶œë˜ëŠ” ë©”ì¸ í•¨ìˆ˜
            function saveSignature() {
                // templateId ì„¤ì • (í…œí”Œë¦¿ ì„ íƒ ìƒíƒœì— ë”°ë¼)
                const templateSelect = document.getElementById('templateSelect');
                const templateIdHidden = document.getElementById('templateIdHidden');
                if (templateSelect && templateIdHidden) {
                    templateIdHidden.value = templateSelect.value;
                }

                // 1. ë¨¼ì € ëª¨ë“  ë°ì´í„° ìˆ˜ì§‘ (renderInstanceê°€ ìˆì„ ë•Œ)
                collectAndSaveFormData();

                // 2. ì„œëª… ë°ì´í„° ì €ì¥
                saveAllSignatures();

                // 3. í¼ ì œì¶œ í—ˆìš©
                return true;
            }

            // í¼ ì œì¶œ ì „ ë°ì´í„° ìˆ˜ì§‘ ë° ì €ì¥
            function collectAndSaveFormData() {
                // renderInstanceê°€ ìˆëŠ”ì§€ í™•ì¸
                if (window.renderInstance && typeof window.renderInstance.getData === 'function') {
                    try {
                        // formRenderì˜ getData ë©”ì„œë“œë¡œ ë°ì´í„° ìˆ˜ì§‘
                        const formData = window.renderInstance.getData();
                        if (formData && Object.keys(formData).length > 0) {
                            const jsonOutput = JSON.stringify(formData);
                            document.getElementById("checkResultJson").value = jsonOutput;
                            return;
                        }
                    } catch (error) {
                        // getData ë©”ì„œë“œ ì‹¤íŒ¨ ì‹œ fallback
                    }
                }

                // fallback: ì§ì ‘ ìˆ˜ì§‘
                const formData = collectFormDataDirectly();
                if (formData && Object.keys(formData).length > 0) {
                    const jsonOutput = JSON.stringify(formData);
                    document.getElementById("checkResultJson").value = jsonOutput;
                } else {
                    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ ì €ì¥
                    document.getElementById("checkResultJson").value = "{}";
                }
            }

            // ê¸°ì¡´ ì²´í¬ì‹œíŠ¸ ë°ì´í„° ë³µì›
            function restoreCheckResultData() {
                const checkResultJson = document.getElementById("checkResultJson").value;
                if (checkResultJson && checkResultJson !== "{}" && checkResultJson !== "{no template selected}") {
                    try {
                        const savedData = JSON.parse(checkResultJson);
                        console.log('ë³µì›í•  ì²´í¬ì‹œíŠ¸ ë°ì´í„°:', savedData);

                        // formRenderì— ë°ì´í„° ë³µì›
                        if (window.renderInstance && typeof window.renderInstance.setData === 'function') {
                            window.renderInstance.setData(savedData);
                            console.log('formRender setDataë¡œ ë°ì´í„° ë³µì› ì™„ë£Œ');
                        } else {
                            // setDataê°€ ì—†ìœ¼ë©´ ì§ì ‘ í¼ ìš”ì†Œì— ê°’ ì„¤ì •
                            restoreFormDataDirectly(savedData);
                            console.log('ì§ì ‘ ë³µì›ìœ¼ë¡œ ë°ì´í„° ë³µì› ì™„ë£Œ');
                        }
                    } catch (error) {
                        console.error('ì²´í¬ì‹œíŠ¸ ë°ì´í„° ë³µì› ì‹¤íŒ¨:', error);
                    }
                }
            }

            // í¼ ìš”ì†Œì— ì§ì ‘ ë°ì´í„° ë³µì› (fallbackìš©)
            function restoreFormDataDirectly(savedData) {
                const formElements = document.querySelectorAll('#form-render input, #form-render select, #form-render textarea');

                formElements.forEach((element) => {
                    if (element.name && savedData[element.name] !== undefined) {
                        if (element.type === 'checkbox') {
                            element.checked = savedData[element.name];
                        } else {
                            element.value = savedData[element.name];
                        }
                    }
                });
            }

            // í¼ ìš”ì†Œì—ì„œ ì§ì ‘ ë°ì´í„° ìˆ˜ì§‘í•˜ëŠ” í•¨ìˆ˜ (fallbackìš©)
            function collectFormDataDirectly() {
                const formData = {};

                // form-render ë‚´ë¶€ì˜ ëª¨ë“  í¼ ìš”ì†Œ ìˆ˜ì§‘
                const formElements = document.querySelectorAll('#form-render input, #form-render select, #form-render textarea');

                formElements.forEach((element) => {
                    if (element.name && element.value !== undefined) {
                        if (element.type === 'checkbox') {
                            formData[element.name] = element.checked;
                        } else {
                            formData[element.name] = element.value;
                        }
                    }
                });

                // í…œí”Œë¦¿ì´ ì„ íƒë˜ì–´ ìˆì§€ ì•Šê±°ë‚˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
                if (Object.keys(formData).length === 0) {
                    const templateSelect = document.getElementById('templateSelect');
                    if (templateSelect && templateSelect.value) {
                        // í…œí”Œë¦¿ì´ ì„ íƒë˜ì–´ ìˆì§€ë§Œ ì•„ì§ í¼ì´ ë Œë”ë§ë˜ì§€ ì•Šì€ ê²½ìš°
                        return {};
                    }
                }

                return formData;
            }

            // ì„œëª… ì €ì¥
            function saveAllSignatures() {
                const canvases = document.querySelectorAll('canvas[id^="signatureCanvas"]');

                canvases.forEach(function (canvas, index) {
                    const idx = canvas.id.replace('signatureCanvas', '');

                    // ìº”ë²„ìŠ¤ê°€ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
                    const ctx = canvas.getContext('2d');
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const hasData = imageData.data.some(channel => channel !== 0);

                    if (hasData) {
                        // ì´ë¯¸ì§€ í’ˆì§ˆì„ 0.8ë¡œ ì„¤ì •í•˜ì—¬ íŒŒì¼ í¬ê¸° ìµœì í™”
                        const dataUrl = canvas.toDataURL("image/png", 0.8);
                        // const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
                        const hidden = document.getElementById('signatureData' + idx);
                        if (hidden) {
                            hidden.value = dataUrl;
                        }
                    }
                });
            }

            // ì„œëª… ì´ˆê¸°í™”
            function clearSignature(idx) {
                const canvas = document.getElementById('signatureCanvas' + idx);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                const hidden = document.getElementById('signatureData' + idx);
                if (hidden) hidden.value = '';
            }

            // ì„œëª…ì ì¶”ê°€
            function addSigner() {
                const tbody = document.getElementById('itemTableBody');
                const newIndex = tbody.rows.length;
                const newRow = tbody.insertRow();
                newRow.className = 'signer-row';

                const orderCell = newRow.insertCell();
                orderCell.className = 'px-4 py-2 border text-center';
                orderCell.innerHTML = `<span class="signer-order">${newIndex + 1}</span>`;

                const nameCell = newRow.insertCell();
                nameCell.className = 'px-4 py-2 border';
                nameCell.innerHTML = `
                    <input type="text" name="items[${newIndex}].signerName" class="w-full border rounded px-2 py-1" 
                        placeholder="ì„œëª…ì ${newIndex + 1}ëª…" required />
                `;

                const signatureCell = newRow.insertCell();
                signatureCell.className = 'px-4 py-2 border';
                signatureCell.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <canvas id="signatureCanvas${newIndex}" width="250" height="80"
                            style="border:1px solid #ccc; border-radius: 4px; cursor: crosshair;"
                            class="signature-canvas"></canvas>
                        <input type="hidden" name="items[${newIndex}].signature" id="signatureData${newIndex}" />
                    </div>
                `;

                const actionsCell = newRow.insertCell();
                actionsCell.className = 'px-4 py-2 border';
                actionsCell.innerHTML = `
                    <div class="flex space-x-1">
                        <button type="button" onclick="clearSignature(${newIndex})"
                            class="px-2 py-1 text-blue-600 border border-blue-500 rounded hover:bg-blue-50 text-xs">
                            ì§€ìš°ê¸°
                        </button>
                        <button type="button" onclick="removeSigner(${newIndex})"
                            class="px-2 py-1 text-red-600 border border-red-500 rounded hover:bg-red-50 text-xs">
                            ì‚­ì œ
                        </button>
                    </div>
                `;

                // ìƒˆë¡œ ì¶”ê°€ëœ canvasì— ì„œëª… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                initializeSignatureCanvas(newIndex);

                // ëª¨ë“  ì„œëª…ìì˜ ìˆœì„œ ì—…ë°ì´íŠ¸
                updateSignerOrders();
            }

            // ì„œëª…ì ì‚­ì œ
            function removeSigner(index) {
                const tbody = document.getElementById('itemTableBody');
                const rows = tbody.querySelectorAll('.signer-row');

                if (rows.length > 1) { // ìµœì†Œ 1ëª…ì€ ìœ ì§€
                    const rowToRemove = rows[index];
                    if (rowToRemove) {
                        rowToRemove.remove();
                        updateSignerOrders();
                    }
                } else {
                    alert('ìµœì†Œ 1ëª…ì˜ ì„œëª…ìê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                }
            }

            // ì„œëª…ì ìˆœì„œ ì—…ë°ì´íŠ¸
            function updateSignerOrders() {
                const signerOrders = document.querySelectorAll('.signer-order');
                signerOrders.forEach((orderSpan, index) => {
                    orderSpan.textContent = index + 1;
                });
            }

            // ì„œëª… canvas ì´ˆê¸°í™”
            function initializeSignatureCanvas(index) {
                const canvas = document.getElementById('signatureCanvas' + index);
                if (!canvas) {
                    console.error('Canvas not found:', 'signatureCanvas' + index);
                    return;
                }

                let drawing = false;
                let ctx = canvas.getContext('2d');

                // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';

                let lastX = 0, lastY = 0;

                // ê¸°ì¡´ ì„œëª… ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                const signatureData = document.getElementById('signatureData' + index);
                if (signatureData && signatureData.value && signatureData.value.trim() !== '') {
                    const img = new Image();
                    img.onload = function () {
                        // ìº”ë²„ìŠ¤ í¬ê¸°ì— ë§ê²Œ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = signatureData.value;
                }

                function getXY(e) {
                    if (e.touches) {
                        const rect = canvas.getBoundingClientRect();
                        return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
                    } else {
                        return [e.offsetX, e.offsetY];
                    }
                }

                canvas.addEventListener('mousedown', function (e) {
                    drawing = true;
                    [lastX, lastY] = getXY(e);
                });
                canvas.addEventListener('mousemove', function (e) {
                    if (!drawing) return;
                    const [x, y] = getXY(e);
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    [lastX, lastY] = [x, y];
                });
                canvas.addEventListener('mouseup', function () { drawing = false; });
                canvas.addEventListener('mouseout', function () { drawing = false; });
                canvas.addEventListener('touchstart', function (e) {
                    drawing = true;
                    [lastX, lastY] = getXY(e);
                });
                canvas.addEventListener('touchmove', function (e) {
                    if (!drawing) return;
                    const [x, y] = getXY(e);
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    [lastX, lastY] = [x, y];
                    e.preventDefault();
                }, { passive: false });
                canvas.addEventListener('touchend', function () { drawing = false; });


            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ê¸°ì¡´ canvas ì´ˆê¸°í™”
            function initializeAllSignatureCanvases() {
                const canvases = document.querySelectorAll('canvas[id^="signatureCanvas"]');
                canvases.forEach(function (canvas, index) {
                    initializeSignatureCanvas(index);
                });
            }

            // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
            initializeAllSignatureCanvases();
        </script>
    </th:block>
</body>

</html>