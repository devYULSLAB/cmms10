<!-- workPermitForm.html -->
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/defaultLayout}">

<head>
    <title>ì‘ì—…í—ˆê°€ì„œ ë“±ë¡</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="max-w-4xl mx-auto mt-8 space-y-6">
            <h2 class="text-2xl font-bold"
                th:text="${workpermit.permitId == null ? 'ì‘ì—…í—ˆê°€ì„œ ì‹ ê·œ' : 'ì‘ì—…í—ˆê°€ì„œ ìˆ˜ì •: ' + workpermit.permitId}">ì‘ì—…í—ˆê°€ì„œ ë“±ë¡</h2>
            <!-- Alerts -->
            <div th:if="${successMessage}" class="p-3 bg-green-100 text-green-800 rounded">
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="p-3 bg-red-100 text-red-800 rounded">
                <span th:text="${errorMessage}"></span>
            </div>

            <form th:action="@{/workpermit/workpermitSave}" method="post" th:object="${workpermit}"
                onsubmit="saveSignature()">
                <!-- Hidden fields -->
                <input type="hidden" th:field="*{companyId}" />

                <!-- Basic Info -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2" th:text="#{basicInformation}">Basic Information</h3>
                    <div class="grid grid-cols-12 gap-4">
                        <div class="col-span-3">
                            <label class="block text-sm font-medium mb-1" th:text="#{permitId}">Permit ID</label>
                            <input type="text" th:field="*{permitId}"
                                class="w-full border rounded px-2 py-1 bg-gray-100" readonly />
                        </div>
                        <div class="col-span-3">
                            <label class="block text-sm font-medium mb-1" th:text="#{plantId}">Plant ID</label>
                            <input type="text" th:field="*{plantId}" class="w-full border rounded px-2 py-1" />
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1" th:text="#{permitType}">Permit Type</label>
                            <input type="text" th:field="*{permitType}" class="w-full border rounded px-2 py-1" />
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1" th:text="#{siteId}">Site</label>
                            <input type="text" id="siteId" th:field="*{siteId}"
                                class="w-full border rounded px-2 py-1" />
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1" th:text="#{deptId}">Dept</label>
                            <input type="text" th:field="*{deptId}" class="w-full border rounded px-2 py-1" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" th:text="#{permitName}">Permit Name</label>
                        <input type="text" th:field="*{permitName}" class="w-full border rounded px-2 py-1" />
                    </div>
                </div>
                <!-- Permit Period -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2" th:text="#{permitPeriod}">Permit Period</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{startDate}">Start Date</label>
                            <input type="date" th:field="*{startDate}" class="w-full border rounded px-2 py-1" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{endDate}">End Date</label>
                            <input type="date" th:field="*{endDate}" class="w-full border rounded px-2 py-1" />
                        </div>
                    </div>
                </div>

                <!-- Permit Description -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2" th:text="#{permitDescription}">Permit Description</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{workDesc}">Work Description</label>
                            <textarea th:field="*{workDesc}" rows="3"
                                class="w-full border rounded px-2 py-1"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{hazardNote}">Hazard Note</label>
                            <textarea th:field="*{hazardNote}" rows="3"
                                class="w-full border rounded px-2 py-1"></textarea>
                        </div>
                    </div>
                </div>
                <!-- Permit Safety Measures -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2" th:text="#{safetyMeasures}">Permit Safety Measures</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{safetyMeasure}">Safety
                                Measure</label>
                            <textarea th:field="*{safetyMeasure}" rows="3"
                                class="w-full border rounded px-2 py-1"></textarea>
                        </div>
                    </div>
                </div>
                <!-- Permit Signatures items-->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-semibold text-lg mb-2" th:text="#{signature}">Permit Signatures</h3>
                        <button type="button" onclick="addSigner()"
                            class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                            <i class="fas fa-plus mr-1"></i>ì„œëª…ì ì¶”ê°€
                        </button>
                    </div>
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 border text-left">ìˆœì„œ</th>
                                <th class="px-4 py-2 border text-left">ì„œëª…ìëª…</th>
                                <th class="px-4 py-2 border text-left">ì„œëª…</th>
                                <th class="px-4 py-2 border text-left">ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody id="itemTableBody">
                            <tr th:each="item, iterStat : *{items}" class="signer-row">
                                <td class="px-4 py-2 border text-center">
                                    <span class="signer-order" th:text="${iterStat.count}"></span>
                                </td>
                                <td class="px-4 py-2 border">
                                    <input type="text" th:field="*{items[__${iterStat.index}__].signerName}"
                                        class="w-full border rounded px-2 py-1"
                                        th:placeholder="'ì„œëª…ì ' + ${iterStat.count} + 'ëª…'" required />
                                </td>
                                <td class="px-4 py-2 border">
                                    <div class="flex items-center space-x-2">
                                        <canvas th:attr="id='signatureCanvas' + ${iterStat.index}" width="250"
                                            height="80"
                                            style="border:1px solid #ccc; border-radius: 4px; cursor: crosshair;"
                                            class="signature-canvas"></canvas>
                                        <input type="hidden" th:field="*{items[__${iterStat.index}__].signature}"
                                            th:attr="id='signatureData' + ${iterStat.index}" />
                                    </div>
                                </td>
                                <td class="px-4 py-2 border">
                                    <div class="flex space-x-1">
                                        <button type="button"
                                            th:attr="onclick='clearSignature(' + ${iterStat.index} + ')'"
                                            class="px-2 py-1 text-blue-600 border border-blue-500 rounded hover:bg-blue-50 text-xs">
                                            ì§€ìš°ê¸°
                                        </button>
                                        <button type="button"
                                            th:attr="onclick='removeSigner(' + ${iterStat.index} + ')'"
                                            class="px-2 py-1 text-red-600 border border-red-500 rounded hover:bg-red-50 text-xs">
                                            ì‚­ì œ
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <!-- ê¸°ë³¸ ì„œëª…ì í–‰ (ë°ì´í„°ê°€ ì—†ì„ ë•Œ) -->
                            <tr th:if="${#lists.isEmpty(items)}" class="signer-row">
                                <td class="px-4 py-2 border text-center">
                                    <span class="signer-order">1</span>
                                </td>
                                <td class="px-4 py-2 border">
                                    <input type="text" name="items[0].signerName"
                                        class="w-full border rounded px-2 py-1" placeholder="ì„œëª…ì 1ëª…" required />
                                </td>
                                <td class="px-4 py-2 border">
                                    <div class="flex items-center space-x-2">
                                        <canvas id="signatureCanvas0" width="250" height="80"
                                            style="border:1px solid #ccc; border-radius: 4px; cursor: crosshair;"
                                            class="signature-canvas"></canvas>
                                        <input type="hidden" name="items[0].signature" id="signatureData0" />
                                    </div>
                                </td>
                                <td class="px-4 py-2 border">
                                    <div class="flex space-x-1">
                                        <button type="button" onclick="clearSignature(0)"
                                            class="px-2 py-1 text-blue-600 border border-blue-500 rounded hover:bg-blue-50 text-xs">
                                            ì§€ìš°ê¸°
                                        </button>
                                        <button type="button" onclick="removeSigner(0)"
                                            class="px-2 py-1 text-red-600 border border-red-500 rounded hover:bg-red-50 text-xs">
                                            ì‚­ì œ
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="text-sm text-gray-600 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        ìµœì†Œ 1ëª…ì˜ ì„œëª…ìê°€ í•„ìš”í•©ë‹ˆë‹¤. ì„œëª…ìëŠ” ìˆœì„œëŒ€ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.
                    </div>
                </div>

                <!-- ì²´í¬ì‹œíŠ¸ í…œí”Œë¦¿ ì„ íƒ -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2">ğŸ§¾ ì•ˆì „ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
                    <div class="mb-2">
                        <label class="block text-sm font-medium mb-1">í…œí”Œë¦¿ ì„ íƒ</label>
                        <select id="templateSelect" name="templateId" class="w-full border rounded p-2">
                            <option value="">-- í…œí”Œë¦¿ ì„ íƒ --</option>
                            <option th:each="tpl : ${templateList}" th:value="${tpl.templateId}"
                                th:text="${tpl.templateName}">
                            </option>
                        </select>
                    </div>

                    <!-- formRender.jsë¡œ í…œí”Œë¦¿ í‘œì‹œ -->
                    <div id="form-render" class="border rounded p-4 bg-gray-50"></div>

                    <!-- ì²´í¬ ê²°ê³¼ ì €ì¥ìš© -->
                    <textarea id="checkResultJson" name="checkResultJson" hidden></textarea>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                        th:text="#{save}">ì €ì¥ </button>
                </div>
            </form>
        </div>
    </div>
    <th:block layout:fragment="page-js">
        <script th:inline="javascript">
            // DOM ë¡œë“œ í›„ ì‹¤í–‰
            document.addEventListener('DOMContentLoaded', function () {
                // âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ í…œí”Œë¦¿ ë Œë”ë§
                const templateJsonMap = /*[[${templateJsonMap}]]*/ {};
                let renderInstance;

                const templateSelect = document.getElementById('templateSelect');
                const formRender = document.getElementById('form-render');

                if (templateSelect) {
                    templateSelect.addEventListener('change', function () {
                        const tplId = this.value;
                        const json = templateJsonMap[tplId];
                        if (json && window.$) {
                            $('#form-render').formRender({ formData: json });
                            renderInstance = $('#form-render').data('formRender');
                        }
                    });
                }

                // âœ… canvas ì„œëª… ì…ë ¥ ê¸°ëŠ¥ (ì—¬ëŸ¬ ê°œ ì§€ì›)
                const canvases = document.querySelectorAll('canvas[id^="signatureCanvas"]');
                canvases.forEach(function (canvas) {
                    let drawing = false;
                    let ctx = canvas.getContext('2d');
                    let lastX = 0, lastY = 0;
                    function getXY(e) {
                        if (e.touches) {
                            const rect = canvas.getBoundingClientRect();
                            return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
                        } else {
                            return [e.offsetX, e.offsetY];
                        }
                    }
                    canvas.addEventListener('mousedown', function (e) {
                        drawing = true;
                        [lastX, lastY] = getXY(e);
                    });
                    canvas.addEventListener('mousemove', function (e) {
                        if (!drawing) return;
                        const [x, y] = getXY(e);
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        [lastX, lastY] = [x, y];
                    });
                    canvas.addEventListener('mouseup', function () { drawing = false; });
                    canvas.addEventListener('mouseout', function () { drawing = false; });
                    canvas.addEventListener('touchstart', function (e) {
                        drawing = true;
                        [lastX, lastY] = getXY(e);
                    });
                    canvas.addEventListener('touchmove', function (e) {
                        if (!drawing) return;
                        const [x, y] = getXY(e);
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        [lastX, lastY] = [x, y];
                        e.preventDefault();
                    }, { passive: false });
                    canvas.addEventListener('touchend', function () { drawing = false; });
                });

                // âœ… í¼ ì œì¶œ ì‹œ ì„œëª… + ì²´í¬ê²°ê³¼ ì €ì¥
                document.querySelector("form").addEventListener("submit", function () {
                    saveAllSignatures();
                    if (renderInstance) {
                        const jsonOutput = JSON.stringify(renderInstance.userData);
                        document.getElementById("checkResultJson").value = jsonOutput;
                    }
                });
            });

            // ì„œëª… ì €ì¥
            function saveAllSignatures() {
                const canvases = document.querySelectorAll('canvas[id^="signatureCanvas"]');
                canvases.forEach(function (canvas) {
                    const idx = canvas.id.replace('signatureCanvas', '');
                    const dataUrl = canvas.toDataURL("image/png");
                    const hidden = document.getElementById('signatureData' + idx);
                    if (hidden) hidden.value = dataUrl;
                });
            }

            // ì„œëª… ì´ˆê¸°í™”
            function clearSignature(idx) {
                const canvas = document.getElementById('signatureCanvas' + idx);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                const hidden = document.getElementById('signatureData' + idx);
                if (hidden) hidden.value = '';
            }

            // ì„œëª…ì ì¶”ê°€
            function addSigner() {
                const tbody = document.getElementById('itemTableBody');
                const newIndex = tbody.rows.length;
                const newRow = tbody.insertRow();
                newRow.className = 'signer-row';

                const orderCell = newRow.insertCell();
                orderCell.className = 'px-4 py-2 border text-center';
                orderCell.innerHTML = `<span class="signer-order">${newIndex + 1}</span>`;

                const nameCell = newRow.insertCell();
                nameCell.className = 'px-4 py-2 border';
                nameCell.innerHTML = `
                    <input type="text" name="items[${newIndex}].signerName" class="w-full border rounded px-2 py-1" 
                        placeholder="ì„œëª…ì ${newIndex + 1}ëª…" required />
                `;

                const signatureCell = newRow.insertCell();
                signatureCell.className = 'px-4 py-2 border';
                signatureCell.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <canvas id="signatureCanvas${newIndex}" width="250" height="80"
                            style="border:1px solid #ccc; border-radius: 4px; cursor: crosshair;"
                            class="signature-canvas"></canvas>
                        <input type="hidden" name="items[${newIndex}].signature" id="signatureData${newIndex}" />
                    </div>
                `;

                const actionsCell = newRow.insertCell();
                actionsCell.className = 'px-4 py-2 border';
                actionsCell.innerHTML = `
                    <div class="flex space-x-1">
                        <button type="button" onclick="clearSignature(${newIndex})"
                            class="px-2 py-1 text-blue-600 border border-blue-500 rounded hover:bg-blue-50 text-xs">
                            ì§€ìš°ê¸°
                        </button>
                        <button type="button" onclick="removeSigner(${newIndex})"
                            class="px-2 py-1 text-red-600 border border-red-500 rounded hover:bg-red-50 text-xs">
                            ì‚­ì œ
                        </button>
                    </div>
                `;

                // ìƒˆë¡œ ì¶”ê°€ëœ canvasì— ì„œëª… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                initializeSignatureCanvas(newIndex);

                // ëª¨ë“  ì„œëª…ìì˜ ìˆœì„œ ì—…ë°ì´íŠ¸
                updateSignerOrders();
            }

            // ì„œëª…ì ì‚­ì œ
            function removeSigner(index) {
                const tbody = document.getElementById('itemTableBody');
                const rows = tbody.querySelectorAll('.signer-row');

                if (rows.length > 1) { // ìµœì†Œ 1ëª…ì€ ìœ ì§€
                    const rowToRemove = rows[index];
                    if (rowToRemove) {
                        rowToRemove.remove();
                        updateSignerOrders();
                    }
                } else {
                    alert('ìµœì†Œ 1ëª…ì˜ ì„œëª…ìê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                }
            }

            // ì„œëª…ì ìˆœì„œ ì—…ë°ì´íŠ¸
            function updateSignerOrders() {
                const signerOrders = document.querySelectorAll('.signer-order');
                signerOrders.forEach((orderSpan, index) => {
                    orderSpan.textContent = index + 1;
                });
            }

            // ì„œëª… canvas ì´ˆê¸°í™”
            function initializeSignatureCanvas(index) {
                const canvas = document.getElementById('signatureCanvas' + index);
                if (!canvas) return;

                let drawing = false;
                let ctx = canvas.getContext('2d');
                let lastX = 0, lastY = 0;

                // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';

                function getXY(e) {
                    if (e.touches) {
                        const rect = canvas.getBoundingClientRect();
                        return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
                    } else {
                        return [e.offsetX, e.offsetY];
                    }
                }

                canvas.addEventListener('mousedown', function (e) {
                    drawing = true;
                    [lastX, lastY] = getXY(e);
                });
                canvas.addEventListener('mousemove', function (e) {
                    if (!drawing) return;
                    const [x, y] = getXY(e);
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    [lastX, lastY] = [x, y];
                });
                canvas.addEventListener('mouseup', function () { drawing = false; });
                canvas.addEventListener('mouseout', function () { drawing = false; });
                canvas.addEventListener('touchstart', function (e) {
                    drawing = true;
                    [lastX, lastY] = getXY(e);
                });
                canvas.addEventListener('touchmove', function (e) {
                    if (!drawing) return;
                    const [x, y] = getXY(e);
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    [lastX, lastY] = [x, y];
                    e.preventDefault();
                }, { passive: false });
                canvas.addEventListener('touchend', function () { drawing = false; });
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ê¸°ì¡´ canvas ì´ˆê¸°í™”
            function initializeAllSignatureCanvases() {
                const canvases = document.querySelectorAll('canvas[id^="signatureCanvas"]');
                canvases.forEach(function (canvas, index) {
                    initializeSignatureCanvas(index);
                });
            }

            // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
            initializeAllSignatureCanvases();
        </script>
        <!-- ì²´í¬ì‹œíŠ¸ ë Œë”ë§ìš© formRender.js -->
        <script src="https://formbuilder.online/assets/js/form-render.min.js"></script>
    </th:block>
</body>

</html>