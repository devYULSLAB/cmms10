<!-- workPermitForm.html -->
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/defaultLayout}">

<head>
    <title>ì‘ì—…í—ˆê°€ì„œ ë“±ë¡</title>
</head>


<body>
    <div layout:fragment="content">
        <div class="max-w-4xl mx-auto mt-8 space-y-6">
            <h2 class="text-2xl font-bold"
                th:text="${workpermit.permitId == null ? 'ì‘ì—…í—ˆê°€ì„œ ì‹ ê·œ' : 'ì‘ì—…í—ˆê°€ì„œ ìˆ˜ì •: ' + workpermit.permitId}">ì‘ì—…í—ˆê°€ì„œ ë“±ë¡</h2>
            <!-- Alerts -->
            <div th:if="${successMessage}" class="p-3 bg-green-100 text-green-800 rounded">
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="p-3 bg-red-100 text-red-800 rounded">
                <span th:text="${errorMessage}"></span>
            </div>

            <form th:action="@{/workpermit/workpermitSave}" method="post" th:object="${workpermit}"
                onsubmit="return saveSignature()">
                <!-- Hidden fields -->
                <input type="hidden" th:field="*{companyId}" />

                <!-- Basic Info -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2" th:text="#{basicInformation}">Basic Information</h3>
                    <div class="grid grid-cols-12 gap-4">
                        <div class="col-span-3">
                            <label class="block text-sm font-medium mb-1" th:text="#{permitId}">Permit ID</label>
                            <input type="text" th:field="*{permitId}"
                                class="w-full border rounded px-2 py-1 bg-gray-100" readonly />
                        </div>
                        <div class="col-span-3">
                            <label class="block text-sm font-medium mb-1" th:text="#{plantId}">Plant ID</label>
                            <input type="text" th:field="*{plantId}" class="w-full border rounded px-2 py-1" />
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1" th:text="#{permitType}">Permit Type</label>
                            <select th:field="*{permitType}" class="w-full border rounded px-2 py-1">
                                <option value="">-- í—ˆê°€ ìœ í˜• ì„ íƒ --</option>
                                <option th:each="permitType : ${permitTypes}" th:value="${permitType.codeId}"
                                    th:text="${permitType.codeId + ' - ' + permitType.codeName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1" th:text="#{siteId}">Site</label>
                            <select id="siteId" th:field="*{siteId}" class="w-full border rounded px-2 py-1">
                                <option value="">-- Site ì„ íƒ --</option>
                                <option th:each="site : ${sites}" th:value="${site.siteId}"
                                    th:text="${site.siteId + ' - ' + site.siteName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1" th:text="#{deptId}">Dept</label>
                            <select th:field="*{deptId}" class="w-full border rounded px-2 py-1">
                                <option value="">-- ë¶€ì„œ ì„ íƒ --</option>
                                <option th:each="dept : ${depts}" th:value="${dept.deptId}"
                                    th:text="${dept.deptId + ' - ' + dept.deptName}">
                                </option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" th:text="#{permitName}">Permit Name</label>
                        <input type="text" th:field="*{permitName}" class="w-full border rounded px-2 py-1" />
                    </div>
                </div>
                <!-- Permit Period -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2" th:text="#{permitPeriod}">Permit Period</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{startDate}">Start Date</label>
                            <input type="date" th:field="*{startDate}" class="w-full border rounded px-2 py-1" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{endDate}">End Date</label>
                            <input type="date" th:field="*{endDate}" class="w-full border rounded px-2 py-1" />
                        </div>
                    </div>
                </div>

                <!-- Permit Description -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2" th:text="#{permitDescription}">Permit Description</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{workDesc}">Work Description</label>
                            <textarea th:field="*{workDesc}" rows="3"
                                class="w-full border rounded px-2 py-1"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{hazardNote}">Hazard Note</label>
                            <textarea th:field="*{hazardNote}" rows="3"
                                class="w-full border rounded px-2 py-1"></textarea>
                        </div>
                    </div>
                </div>
                <!-- Permit Safety Measures -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2" th:text="#{safetyMeasures}">Permit Safety Measures</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" th:text="#{safetyMeasure}">Safety
                                Measure</label>
                            <textarea th:field="*{safetyMeasure}" rows="3"
                                class="w-full border rounded px-2 py-1"></textarea>
                        </div>
                    </div>
                </div>
                <!-- Permit Signatures items-->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-semibold text-lg mb-2" th:text="#{signature}">Permit Signatures</h3>
                        <button type="button" onclick="addSigner()"
                            class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                            <i class="fas fa-plus mr-1"></i>ì„œëª…ì ì¶”ê°€
                        </button>
                    </div>
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 border text-left">ìˆœì„œ</th>
                                <th class="px-4 py-2 border text-left">ì„œëª…ìëª…</th>
                                <th class="px-4 py-2 border text-left">ì„œëª…</th>
                                <th class="px-4 py-2 border text-left">ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody id="itemTableBody">
                            <tr th:each="item, iterStat : *{items}" class="signer-row">
                                <td class="px-4 py-2 border text-center">
                                    <span class="signer-order" th:text="${iterStat.count}"></span>
                                </td>
                                <td class="px-4 py-2 border">
                                    <input type="text" th:field="*{items[__${iterStat.index}__].signerName}"
                                        class="w-full border rounded px-2 py-1"
                                        th:placeholder="'ì„œëª…ì ' + ${iterStat.count} + 'ëª…'" required />
                                </td>
                                <td class="px-4 py-2 border">
                                    <div class="flex items-center space-x-2">
                                        <canvas th:attr="id='signatureCanvas' + ${iterStat.index}" width="250"
                                            height="80"
                                            style="border:1px solid #ccc; border-radius: 4px; cursor: crosshair;"
                                            class="signature-canvas"></canvas>
                                        <input type="hidden" th:field="*{items[__${iterStat.index}__].signature}"
                                            th:attr="id='signatureData' + ${iterStat.index}"
                                            th:name="items[__${iterStat.index}__].signature" />
                                    </div>
                                </td>
                                <td class="px-4 py-2 border">
                                    <div class="flex space-x-1">
                                        <button type="button"
                                            th:attr="onclick='clearSignature(' + ${iterStat.index} + ')'"
                                            class="px-2 py-1 text-blue-600 border border-blue-500 rounded hover:bg-blue-50 text-xs">
                                            ì§€ìš°ê¸°
                                        </button>
                                        <button type="button"
                                            th:attr="onclick='removeSigner(' + ${iterStat.index} + ')'"
                                            class="px-2 py-1 text-red-600 border border-red-500 rounded hover:bg-red-50 text-xs">
                                            ì‚­ì œ
                                        </button>
                                    </div>
                                </td>
                            </tr>

                        </tbody>
                    </table>
                    <div class="text-sm text-gray-600 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        ìµœì†Œ 1ëª…ì˜ ì„œëª…ìê°€ í•„ìš”í•©ë‹ˆë‹¤. ì„œëª…ìëŠ” ìˆœì„œëŒ€ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.
                    </div>
                </div>

                <!-- ì²´í¬ì‹œíŠ¸ í…œí”Œë¦¿ ì„ íƒ -->
                <div class="border rounded-lg shadow p-4 space-y-4">
                    <h3 class="font-semibold text-lg mb-2">ğŸ§¾ ì•ˆì „ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
                    <div class="mb-2">
                        <label class="block text-sm font-medium mb-1">í…œí”Œë¦¿ ì„ íƒ</label>
                        <select id="templateSelect" name="templateId" class="w-full border rounded p-2">
                            <option value="">-- í…œí”Œë¦¿ ì„ íƒ --</option>
                            <option th:each="tpl : ${templateList}" th:value="${tpl.templateId}"
                                th:text="${tpl.templateName}">
                            </option>
                        </select>
                    </div>

                    <!-- formRender.jsë¡œ í…œí”Œë¦¿ í‘œì‹œ -->
                    <div id="form-render" class="border rounded p-4 bg-gray-50 min-h-[200px]">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-clipboard-list text-2xl mb-2"></i>
                            <p>í…œí”Œë¦¿ì„ ì„ íƒí•˜ë©´ ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <!-- ì²´í¬ ê²°ê³¼ ì €ì¥ìš© -->
                    <textarea id="checkResultJson" name="checkResultJson" hidden></textarea>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                        th:text="#{save}">ì €ì¥ </button>
                </div>
            </form>
        </div>
    </div>
    <th:block layout:fragment="page-js">
        <!-- ì²´í¬ì‹œíŠ¸ ë Œë”ë§ìš© formRender.js -->
        <script src="https://formbuilder.online/assets/js/form-render.min.js"></script>
        <script th:inline="javascript">
            // DOM ë¡œë“œ í›„ ì‹¤í–‰
            document.addEventListener('DOMContentLoaded', function () {
                // âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ í…œí”Œë¦¿ ë Œë”ë§
                const templateJsonMap = /*[[${templateJsonMap}]]*/ {};
                console.log('í…œí”Œë¦¿ ë§µ ì´ˆê¸°í™”:', templateJsonMap);
                let renderInstance;

                const templateSelect = document.getElementById('templateSelect');
                const formRender = document.getElementById('form-render');

                if (templateSelect) {
                    templateSelect.addEventListener('change', function () {
                        const tplId = this.value;
                        console.log('í…œí”Œë¦¿ ì„ íƒ:', tplId);
                        console.log('í…œí”Œë¦¿ ë§µ:', templateJsonMap);

                        const json = templateJsonMap[tplId];
                        console.log('ì„ íƒëœ JSON:', json);

                        if (json && window.$ && window.$.fn.formRender) {
                            console.log('formRender ì‚¬ìš© ê°€ëŠ¥');
                            // ê¸°ì¡´ í¼ ì œê±°
                            $('#form-render').empty();
                            // ìƒˆ í¼ ë Œë”ë§
                            $('#form-render').formRender({
                                formData: json,
                                readOnly: false
                            });
                            renderInstance = $('#form-render').data('formRender');
                            console.log('ë Œë”ë§ ì™„ë£Œ');

                            // ì²´í¬ê²°ê³¼ í•„ë“œ ì´ˆê¸°í™”
                            document.getElementById("checkResultJson").value = "{}";
                            console.log('ì²´í¬ê²°ê³¼ í•„ë“œ ì´ˆê¸°í™” ì™„ë£Œ');
                        } else if (!tplId) {
                            // í…œí”Œë¦¿ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš°
                            $('#form-render').html(`
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-clipboard-list text-2xl mb-2"></i>
                                    <p>í…œí”Œë¦¿ì„ ì„ íƒí•˜ë©´ ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </div>
                            `);
                            renderInstance = null;
                            document.getElementById("checkResultJson").value = "{}";
                            console.log('í…œí”Œë¦¿ ì„ íƒ í•´ì œ - ì²´í¬ê²°ê³¼ í•„ë“œì— ë¹ˆ ê°ì²´ ì„¤ì •');
                        } else {
                            console.error('formRenderë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            $('#form-render').html(`
                                <div class="text-center text-red-500 py-8">
                                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                    <p>í…œí”Œë¦¿ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                                    <p class="text-sm">JSON: ${json ? 'ìˆìŒ' : 'ì—†ìŒ'}</p>
                                    <p class="text-sm">jQuery: ${window.$ ? 'ìˆìŒ' : 'ì—†ìŒ'}</p>
                                    <p class="text-sm">formRender: ${window.$ && window.$.fn.formRender ? 'ìˆìŒ' : 'ì—†ìŒ'}</p>
                                </div>
                            `);
                            renderInstance = null;
                            document.getElementById("checkResultJson").value = "{}";
                        }
                    });
                }

                // âœ… canvas ì„œëª… ì…ë ¥ ê¸°ëŠ¥ (ì—¬ëŸ¬ ê°œ ì§€ì›)
                const canvases = document.querySelectorAll('canvas[id^="signatureCanvas"]');
                canvases.forEach(function (canvas) {
                    let drawing = false;
                    let ctx = canvas.getContext('2d');

                    // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';

                    let lastX = 0, lastY = 0;

                    function getXY(e) {
                        if (e.touches) {
                            const rect = canvas.getBoundingClientRect();
                            return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
                        } else {
                            return [e.offsetX, e.offsetY];
                        }
                    }

                    canvas.addEventListener('mousedown', function (e) {
                        drawing = true;
                        [lastX, lastY] = getXY(e);
                    });
                    canvas.addEventListener('mousemove', function (e) {
                        if (!drawing) return;
                        const [x, y] = getXY(e);
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        [lastX, lastY] = [x, y];
                    });
                    canvas.addEventListener('mouseup', function () { drawing = false; });
                    canvas.addEventListener('mouseout', function () { drawing = false; });
                    canvas.addEventListener('touchstart', function (e) {
                        drawing = true;
                        [lastX, lastY] = getXY(e);
                    });
                    canvas.addEventListener('touchmove', function (e) {
                        if (!drawing) return;
                        const [x, y] = getXY(e);
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        [lastX, lastY] = [x, y];
                        e.preventDefault();
                    }, { passive: false });
                    canvas.addEventListener('touchend', function () { drawing = false; });
                });

                // âœ… í¼ ì œì¶œ ì‹œ ë””ë²„ê¹… ì •ë³´ ì¶œë ¥ (saveSignature() í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë¡œê·¸ë§Œ)
                document.querySelector("form").addEventListener("submit", function (e) {
                    console.log("í¼ ì œì¶œ ì´ë²¤íŠ¸ ë°œìƒ - saveSignature() í•¨ìˆ˜ê°€ ì²˜ë¦¬í•¨");

                    // ëª¨ë“  hidden í•„ë“œ ê°’ í™•ì¸
                    const hiddenFields = document.querySelectorAll('input[type="hidden"]');
                    console.log("=== Hidden í•„ë“œ í™•ì¸ ===");
                    hiddenFields.forEach(function (field) {
                        if (field.name && field.name.includes('signature')) {
                            console.log("ì„œëª… í•„ë“œ:", field.name, "ê°’ ê¸¸ì´:", field.value ? field.value.length : 0);
                        }
                    });

                    // ì²´í¬ê²°ê³¼ í•„ë“œ í™•ì¸
                    const checkResultField = document.getElementById("checkResultJson");
                    console.log("ì²´í¬ê²°ê³¼ í•„ë“œ ê°’ ê¸¸ì´:", checkResultField ? checkResultField.value.length : 0);
                    console.log("ì²´í¬ê²°ê³¼ í•„ë“œ ê°’:", checkResultField ? checkResultField.value : "null");
                });
            });

            // í¼ ì œì¶œ ì‹œ í˜¸ì¶œë˜ëŠ” ë©”ì¸ í•¨ìˆ˜
            function saveSignature() {
                console.log("=== saveSignature() í˜¸ì¶œë¨ ===");

                // ì„œëª… ë°ì´í„° ì €ì¥
                saveAllSignatures();

                // ì²´í¬ì‹œíŠ¸ ê²°ê³¼ ì €ì¥
                saveCheckResult();

                console.log("=== saveSignature() ì™„ë£Œ ===");
                return true; // í¼ ì œì¶œ í—ˆìš©
            }

            // ì²´í¬ì‹œíŠ¸ ê²°ê³¼ ì €ì¥
            function saveCheckResult() {
                console.log("=== ì²´í¬ì‹œíŠ¸ ê²°ê³¼ ì €ì¥ ì‹œì‘ ===");

                const templateSelect = document.getElementById('templateSelect');
                const selectedTemplateId = templateSelect ? templateSelect.value : '';
                console.log("ì„ íƒëœ í…œí”Œë¦¿ ID:", selectedTemplateId);

                // í…œí”Œë¦¿ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ë¹ˆ ê°ì²´ ì €ì¥
                if (!selectedTemplateId) {
                    console.log("í…œí”Œë¦¿ì´ ì„ íƒë˜ì§€ ì•ŠìŒ - ë¹ˆ ê°ì²´ ì €ì¥");
                    document.getElementById("checkResultJson").value = "{}";
                    return;
                }

                // renderInstanceê°€ ì—†ëŠ” ê²½ìš° ë¹ˆ ê°ì²´ ì €ì¥
                if (!renderInstance) {
                    console.log("renderInstanceê°€ ì—†ìŒ - ë¹ˆ ê°ì²´ ì €ì¥");
                    document.getElementById("checkResultJson").value = "{}";
                    return;
                }

                try {
                    // í¼ ìš”ì†Œì—ì„œ ì§ì ‘ ë°ì´í„° ìˆ˜ì§‘ (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•)
                    const formData = collectFormData();
                    console.log("ìˆ˜ì§‘ëœ í¼ ë°ì´í„°:", formData);

                    if (formData && Object.keys(formData).length > 0) {
                        const jsonOutput = JSON.stringify(formData);
                        document.getElementById("checkResultJson").value = jsonOutput;
                        console.log("ì²´í¬ê²°ê³¼ JSON ì €ì¥ ì„±ê³µ:", jsonOutput.substring(0, Math.min(200, jsonOutput.length)) + "...");
                        console.log("ì²´í¬ê²°ê³¼ ê¸¸ì´:", jsonOutput.length);
                    } else {
                        console.log("í¼ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ - ë¹ˆ ê°ì²´ ì €ì¥");
                        document.getElementById("checkResultJson").value = "{}";
                    }
                } catch (error) {
                    console.error("ì²´í¬ê²°ê³¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
                    document.getElementById("checkResultJson").value = "{}";
                }

                console.log("=== ì²´í¬ì‹œíŠ¸ ê²°ê³¼ ì €ì¥ ì™„ë£Œ ===");
            }

            // í¼ ìš”ì†Œì—ì„œ ì§ì ‘ ë°ì´í„° ìˆ˜ì§‘í•˜ëŠ” í•¨ìˆ˜
            function collectFormData() {
                const formData = {};
                const formElements = document.querySelectorAll('#form-render input, #form-render select, #form-render textarea');

                formElements.forEach(element => {
                    if (element.name && element.value !== undefined) {
                        // ì²´í¬ë°•ìŠ¤ì˜ ê²½ìš° ì²´í¬ ì—¬ë¶€ë¥¼ í™•ì¸
                        if (element.type === 'checkbox') {
                            formData[element.name] = element.checked;
                        } else {
                            formData[element.name] = element.value;
                        }
                    }
                });

                console.log("í¼ ìš”ì†Œì—ì„œ ìˆ˜ì§‘ëœ ë°ì´í„°:", formData);
                console.log("ìˆ˜ì§‘ëœ ìš”ì†Œ ê°œìˆ˜:", formElements.length);
                return formData;
            }

            // ì„œëª… ì €ì¥
            function saveAllSignatures() {
                console.log("ì„œëª… ì €ì¥ ì‹œì‘");
                const canvases = document.querySelectorAll('canvas[id^="signatureCanvas"]');
                console.log("ë°œê²¬ëœ ìº”ë²„ìŠ¤ ê°œìˆ˜:", canvases.length);

                canvases.forEach(function (canvas, index) {
                    const idx = canvas.id.replace('signatureCanvas', '');
                    console.log("ìº”ë²„ìŠ¤ ID:", canvas.id, "ì¸ë±ìŠ¤:", idx);

                    // ìº”ë²„ìŠ¤ê°€ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
                    const ctx = canvas.getContext('2d');
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const hasData = imageData.data.some(channel => channel !== 0);

                    if (hasData) {
                        // ì´ë¯¸ì§€ í’ˆì§ˆì„ 0.8ë¡œ ì„¤ì •í•˜ì—¬ íŒŒì¼ í¬ê¸° ìµœì í™”
                        const dataUrl = canvas.toDataURL("image/png", 0.8);
                        const hidden = document.getElementById('signatureData' + idx);
                        if (hidden) {
                            hidden.value = dataUrl;
                            console.log("ì„œëª… ë°ì´í„° ì €ì¥ë¨:", idx, "ê¸¸ì´:", dataUrl.length);
                        } else {
                            console.error("hidden í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:", 'signatureData' + idx);
                        }
                    } else {
                        console.log("ìº”ë²„ìŠ¤ê°€ ë¹„ì–´ìˆìŒ:", idx);
                    }
                });
                console.log("ì„œëª… ì €ì¥ ì™„ë£Œ");
            }

            // ì„œëª… ì´ˆê¸°í™”
            function clearSignature(idx) {
                const canvas = document.getElementById('signatureCanvas' + idx);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                const hidden = document.getElementById('signatureData' + idx);
                if (hidden) hidden.value = '';
            }

            // ì„œëª…ì ì¶”ê°€
            function addSigner() {
                const tbody = document.getElementById('itemTableBody');
                const newIndex = tbody.rows.length;
                const newRow = tbody.insertRow();
                newRow.className = 'signer-row';

                const orderCell = newRow.insertCell();
                orderCell.className = 'px-4 py-2 border text-center';
                orderCell.innerHTML = `<span class="signer-order">${newIndex + 1}</span>`;

                const nameCell = newRow.insertCell();
                nameCell.className = 'px-4 py-2 border';
                nameCell.innerHTML = `
                    <input type="text" name="items[${newIndex}].signerName" class="w-full border rounded px-2 py-1" 
                        placeholder="ì„œëª…ì ${newIndex + 1}ëª…" required />
                `;

                const signatureCell = newRow.insertCell();
                signatureCell.className = 'px-4 py-2 border';
                signatureCell.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <canvas id="signatureCanvas${newIndex}" width="250" height="80"
                            style="border:1px solid #ccc; border-radius: 4px; cursor: crosshair;"
                            class="signature-canvas"></canvas>
                        <input type="hidden" name="items[${newIndex}].signature" id="signatureData${newIndex}" />
                    </div>
                `;

                const actionsCell = newRow.insertCell();
                actionsCell.className = 'px-4 py-2 border';
                actionsCell.innerHTML = `
                    <div class="flex space-x-1">
                        <button type="button" onclick="clearSignature(${newIndex})"
                            class="px-2 py-1 text-blue-600 border border-blue-500 rounded hover:bg-blue-50 text-xs">
                            ì§€ìš°ê¸°
                        </button>
                        <button type="button" onclick="removeSigner(${newIndex})"
                            class="px-2 py-1 text-red-600 border border-red-500 rounded hover:bg-red-50 text-xs">
                            ì‚­ì œ
                        </button>
                    </div>
                `;

                // ìƒˆë¡œ ì¶”ê°€ëœ canvasì— ì„œëª… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                initializeSignatureCanvas(newIndex);

                // ëª¨ë“  ì„œëª…ìì˜ ìˆœì„œ ì—…ë°ì´íŠ¸
                updateSignerOrders();
            }

            // ì„œëª…ì ì‚­ì œ
            function removeSigner(index) {
                const tbody = document.getElementById('itemTableBody');
                const rows = tbody.querySelectorAll('.signer-row');

                if (rows.length > 1) { // ìµœì†Œ 1ëª…ì€ ìœ ì§€
                    const rowToRemove = rows[index];
                    if (rowToRemove) {
                        rowToRemove.remove();
                        updateSignerOrders();
                    }
                } else {
                    alert('ìµœì†Œ 1ëª…ì˜ ì„œëª…ìê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                }
            }

            // ì„œëª…ì ìˆœì„œ ì—…ë°ì´íŠ¸
            function updateSignerOrders() {
                const signerOrders = document.querySelectorAll('.signer-order');
                signerOrders.forEach((orderSpan, index) => {
                    orderSpan.textContent = index + 1;
                });
            }

            // ì„œëª… canvas ì´ˆê¸°í™”
            function initializeSignatureCanvas(index) {
                const canvas = document.getElementById('signatureCanvas' + index);
                if (!canvas) {
                    console.error('ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', 'signatureCanvas' + index);
                    return;
                }

                let drawing = false;
                let ctx = canvas.getContext('2d');

                // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';

                let lastX = 0, lastY = 0;

                function getXY(e) {
                    if (e.touches) {
                        const rect = canvas.getBoundingClientRect();
                        return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
                    } else {
                        return [e.offsetX, e.offsetY];
                    }
                }

                canvas.addEventListener('mousedown', function (e) {
                    drawing = true;
                    [lastX, lastY] = getXY(e);
                });
                canvas.addEventListener('mousemove', function (e) {
                    if (!drawing) return;
                    const [x, y] = getXY(e);
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    [lastX, lastY] = [x, y];
                });
                canvas.addEventListener('mouseup', function () { drawing = false; });
                canvas.addEventListener('mouseout', function () { drawing = false; });
                canvas.addEventListener('touchstart', function (e) {
                    drawing = true;
                    [lastX, lastY] = getXY(e);
                });
                canvas.addEventListener('touchmove', function (e) {
                    if (!drawing) return;
                    const [x, y] = getXY(e);
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    [lastX, lastY] = [x, y];
                    e.preventDefault();
                }, { passive: false });
                canvas.addEventListener('touchend', function () { drawing = false; });

                console.log('ì„œëª… ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ:', index);
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ê¸°ì¡´ canvas ì´ˆê¸°í™”
            function initializeAllSignatureCanvases() {
                const canvases = document.querySelectorAll('canvas[id^="signatureCanvas"]');
                canvases.forEach(function (canvas, index) {
                    initializeSignatureCanvas(index);
                });
            }

            // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
            initializeAllSignatureCanvases();
        </script>
    </th:block>
</body>

</html>
