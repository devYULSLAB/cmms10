<!DOCTYPE html>
<!--
íŒ¨í‚¤ì§€: com.cmms10.checksheet
íŒŒì¼: checksheetResultDetail.html
ì£¼ìš”ê¸°ëŠ¥: ì²´í¬ì‹œíŠ¸ ê²°ê³¼ ìƒì„¸ì •ë³´ ì¶œë ¥ ë° í”„ë¦°íŠ¸ í¼
ìƒì„±ì: (ë¡œê·¸ì¸ ì´ë¦„ ì…ë ¥)
ìƒì„±ì¼: (ìƒì„±ì¼ ì…ë ¥)
-->
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/defaultLayout}">

<head>
    <title>ì²´í¬ì‹œíŠ¸ ê²°ê³¼ ìƒì„¸</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="max-w-4xl mx-auto mt-8 space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">ğŸ§¾ ì²´í¬ì‹œíŠ¸ ê²°ê³¼ ìƒì„¸</h2>
                <div class="space-x-2">
                    <a th:if="${checksheetResult != null}"
                        th:href="@{/workpermit/workpermitDetail/{siteId}/{permitId}(siteId=${checksheetResult.companyId},permitId=${checksheetResult.permitId})}"
                        class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">
                        <i class="fas fa-arrow-left mr-2"></i>ì‘ì—…í—ˆê°€ì„œë¡œ ëŒì•„ê°€ê¸°
                    </a>
                    <button th:if="${checksheetResult != null}" onclick="printContent()"
                        class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                        <i class="fas fa-print mr-2"></i>í”„ë¦°íŠ¸
                    </button>
                </div>
            </div>

            <!-- Basic Information -->
            <div th:if="${checksheetResult != null}" class="border rounded-lg shadow p-4 space-y-4">
                <h3 class="font-semibold text-lg mb-2">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>
                <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1">íšŒì‚¬ ID</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${checksheetResult.companyId}"></div>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1">í—ˆê°€ì„œ ID</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${checksheetResult.permitId}"></div>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1">í…œí”Œë¦¿ ID</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${checksheetResult.templateId}"></div>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1">ìƒì„±ì</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${checksheetResult.createBy}"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">ìƒì„±ì¼ì‹œ</label>
                    <div class="p-2 bg-gray-50 rounded"
                        th:text="${#temporals.format(checksheetResult.createDate, 'yyyy-MM-dd HH:mm:ss')}"></div>
                </div>
            </div>

            <!-- Checksheet Result -->
            <div th:if="${checksheetResult != null}" class="border rounded-lg shadow p-4 space-y-4">
                <h3 class="font-semibold text-lg mb-2">âœ… ì²´í¬ì‹œíŠ¸ ê²°ê³¼</h3>
                <div id="checksheetView" class="p-4 bg-gray-50 rounded border min-h-[400px]"></div>
            </div>



            <!-- ì²´í¬ì‹œíŠ¸ ê²°ê³¼ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ -->
            <div th:if="${checksheetResult == null}" class="border rounded-lg shadow p-4 space-y-4">
                <div class="text-center py-12">
                    <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">ì²´í¬ì‹œíŠ¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p class="text-gray-500 mb-4">í•´ë‹¹ ì‘ì—…í—ˆê°€ì„œì— ëŒ€í•œ ì²´í¬ì‹œíŠ¸ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    <a th:href="@{/workpermit/workpermitList}"
                        class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        <i class="fas fa-list mr-2"></i>ì‘ì—…í—ˆê°€ì„œ ëª©ë¡ìœ¼ë¡œ
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Container (ë©”ë‰´ ì œì™¸, contentë§Œ ì¶œë ¥) -->
    <div id="printContainer" style="display: none;">
        <div class="max-w-4xl mx-auto p-6">
            <h2 class="text-2xl font-bold mb-6 text-center">ğŸ§¾ ì²´í¬ì‹œíŠ¸ ê²°ê³¼</h2>

            <!-- Basic Information -->
            <div th:if="${checksheetResult != null}" class="border rounded-lg p-4 space-y-4 mb-6">
                <h3 class="font-semibold text-lg mb-2">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>
                <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1">íšŒì‚¬ ID</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${checksheetResult.companyId}"></div>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1">í—ˆê°€ì„œ ID</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${checksheetResult.permitId}"></div>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1">í…œí”Œë¦¿ ID</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${checksheetResult.templateId}"></div>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-medium mb-1">ìƒì„±ì</label>
                        <div class="p-2 bg-gray-50 rounded" th:text="${checksheetResult.createBy}"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">ìƒì„±ì¼ì‹œ</label>
                    <div class="p-2 bg-gray-50 rounded"
                        th:text="${#temporals.format(checksheetResult.createDate, 'yyyy-MM-dd HH:mm:ss')}"></div>
                </div>
            </div>

            <!-- Checksheet Result -->
            <div th:if="${checksheetResult != null}" class="border rounded-lg p-4 space-y-4 mb-6">
                <h3 class="font-semibold text-lg mb-2">âœ… ì²´í¬ì‹œíŠ¸ ê²°ê³¼</h3>
                <div id="printChecksheetView" class="p-4 bg-gray-50 rounded border min-h-[400px]"></div>
            </div>



            <!-- Footer -->
            <div class="text-center text-sm text-gray-600 mt-8">
                <p>ì¶œë ¥ì¼ì‹œ: <span th:text="${#dates.format(#dates.createNow(), 'yyyy-MM-dd HH:mm')}">-</span></p>
            </div>
        </div>
    </div>

    <th:block layout:fragment="page-js">
        <!-- formRender.js ì‚½ì… -->
        <script src="https://formbuilder.online/assets/js/form-render.min.js"></script>
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function () {
                const checksheetResult = /*[[${checksheetResult}]]*/ null;
                const resultJson = checksheetResult != null ? checksheetResult.checkResultJson : null;
                const templateJson = /*[[${templateJson}]]*/ null; // í…œí”Œë¦¿ JSON ì¶”ê°€

                if (resultJson && resultJson !== '' && resultJson !== '{}' && !resultJson.includes('no renderInstance')) {
                    try {
                        const formData = typeof resultJson === 'string' ? JSON.parse(resultJson) : resultJson;

                        if (formData && Object.keys(formData).length > 0) {
                            if (templateJson) {
                                // í…œí”Œë¦¿ JSONì´ ìˆìœ¼ë©´ formRenderë¡œ ë Œë”ë§
                                $('#checksheetView').formRender({
                                    formData: templateJson, // í…œí”Œë¦¿ êµ¬ì¡° ì‚¬ìš©
                                    readOnly: true,
                                    i18n: false
                                });
                                // ë Œë”ë§ ì™„ë£Œ í›„ ë°ì´í„° ë³µì›
                                setTimeout(() => {
                                    restoreCheckResultData(formData);
                                }, 100);
                            } else {
                                // í…œí”Œë¦¿ JSONì´ ì—†ìœ¼ë©´ ê°„ë‹¨í•œ í¼ ìƒì„±
                                createSimpleForm(formData);
                            }
                        } else {
                            document.getElementById('checksheetView').innerHTML =
                                '<p class="text-gray-500 text-center py-8">ì²´í¬ì‹œíŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        }
                    } catch (e) {
                        document.getElementById('checksheetView').innerHTML =
                            '<p class="text-red-500 text-center py-8">ì²´í¬ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                } else {
                    document.getElementById('checksheetView').innerHTML =
                        '<p class="text-gray-500 text-center py-8">ì²´í¬ì‹œíŠ¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            });

            // ì²´í¬ì‹œíŠ¸ ë°ì´í„° ë³µì› í•¨ìˆ˜
            function restoreCheckResultData(savedData) {
                if (!savedData || Object.keys(savedData).length === 0) {
                    return;
                }

                try {
                    // formRender ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
                    const formRenderInstance = $('#checksheetView').data('formRender');

                    if (formRenderInstance && typeof formRenderInstance.setData === 'function') {
                        // formRenderì˜ setData ë©”ì„œë“œë¡œ ë°ì´í„° ë³µì›
                        formRenderInstance.setData(savedData);
                    } else {
                        // setDataê°€ ì—†ìœ¼ë©´ ì§ì ‘ í¼ ìš”ì†Œì— ê°’ ì„¤ì •
                        restoreFormDataDirectly(savedData);
                    }
                } catch (error) {
                    // fallback: ì§ì ‘ ë³µì›
                    restoreFormDataDirectly(savedData);
                }
            }

            // í¼ ìš”ì†Œì— ì§ì ‘ ë°ì´í„° ë³µì› (fallbackìš©)
            function restoreFormDataDirectly(savedData) {
                const formElements = document.querySelectorAll('#checksheetView input, #checksheetView select, #checksheetView textarea');

                formElements.forEach((element) => {
                    if (element.name && savedData[element.name] !== undefined) {
                        if (element.type === 'checkbox') {
                            element.checked = savedData[element.name];
                        } else {
                            element.value = savedData[element.name];
                        }
                    }
                });
            }

            // ê°„ë‹¨í•œ í¼ ìƒì„± í•¨ìˆ˜ (í…œí”Œë¦¿ JSONì´ ì—†ì„ ë•Œ)
            function createSimpleForm(formData) {
                let html = '<div class="space-y-4">';
                html += '<h4 class="font-medium text-lg mb-4">ì²´í¬ì‹œíŠ¸ ê²°ê³¼</h4>';
                Object.entries(formData).forEach(([fieldName, fieldValue]) => {
                    html += '<div class="border rounded p-3 bg-white">';
                    if (typeof fieldValue === 'boolean') {
                        html += `<label class="flex items-center space-x-2">`;
                        html += `<input type="checkbox" ${fieldValue ? 'checked' : ''} disabled class="rounded">`;
                        html += `<span class="text-sm font-medium">${fieldName}</span>`;
                        html += `</label>`;
                    } else {
                        html += `<label class="block text-sm font-medium mb-1">${fieldName}</label>`;
                        html += `<input type="text" value="${fieldValue}" readonly class="w-full p-2 bg-gray-50 border rounded">`;
                    }
                    html += '</div>';
                });
                html += '</div>';
                document.getElementById('checksheetView').innerHTML = html;
            }

            // ì¸ì‡„ ê¸°ëŠ¥
            function printContent() {
                const printContainer = document.getElementById('printContainer');
                const originalDisplay = printContainer.style.display;

                // Print containerë¥¼ ë³´ì´ê²Œ ì„¤ì •
                printContainer.style.display = 'block';

                // ì²´í¬ì‹œíŠ¸ ë°ì´í„°ë¥¼ print containerì—ë„ ë³µì‚¬
                const checksheetView = document.getElementById('checksheetView');
                const printChecksheetView = document.getElementById('printChecksheetView');
                if (checksheetView && printChecksheetView) {
                    printChecksheetView.innerHTML = checksheetView.innerHTML;
                }

                // í˜„ì¬ í˜ì´ì§€ì˜ ìŠ¤íƒ€ì¼ì„ ì €ì¥
                const originalBodyStyle = document.body.style.cssText;

                // Print containerë§Œ ë³´ì´ë„ë¡ body ìŠ¤íƒ€ì¼ ë³€ê²½
                document.body.innerHTML = printContainer.innerHTML;
                document.body.style.cssText = 'margin: 0; padding: 20px; font-family: Arial, sans-serif;';

                // ì¸ì‡„ ì‹¤í–‰
                window.print();

                // ì›ë˜ í˜ì´ì§€ë¡œ ë³µì›
                window.location.reload();
            }
        </script>
    </th:block>
</body>

</html>