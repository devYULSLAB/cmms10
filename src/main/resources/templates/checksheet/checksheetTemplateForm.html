<!-- 
    íŒŒì¼ëª…: src/main/resources/templates/checksheet/checksheetTemplateForm.html
    í”„ë¡œê·¸ë¨ëª…: CMMS10 - ì²´í¬ì‹œíŠ¸ í…œí”Œë¦¿ ìƒì„±/ìˆ˜ì • í¼
    ì£¼ìš” ê¸°ëŠ¥:
    - ì²´í¬ì‹œíŠ¸ í…œí”Œë¦¿ ì‹ ê·œ ìƒì„± ë° ê¸°ì¡´ í…œí”Œë¦¿ ìˆ˜ì •
    - formBuilder.jsë¥¼ í†µí•œ ë™ì  í¼ êµ¬ì„±
    - í…œí”Œë¦¿ JSON ë°ì´í„° ì €ì¥ ë° ë¡œë”©
    - jQuery UI ê¸°ë°˜ í¼ ë¹Œë” ì¸í„°í˜ì´ìŠ¤
    ìƒì„±ì: system
    ìƒì„±ì¼: 2025-01-08
-->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/defaultLayout}">

<head>
    <title>ì²´í¬ì‹œíŠ¸ í…œí”Œë¦¿ ìƒì„±</title>

    <!-- âœ… jQuery UI: formBuilderì— í•„ìš” -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <!-- formBuilder -->
    <link rel="stylesheet" href="https://formbuilder.online/assets/css/form-builder.min.css">
    <script src="https://formbuilder.online/assets/js/form-builder.min.js"></script>
</head>

<body>
    <div layout:fragment="content">
        <div class="max-w-5xl mx-auto bg-white p-6 rounded shadow">
            <h2 class="text-2xl font-bold mb-4">ğŸ§© ì²´í¬ì‹œíŠ¸ í…œí”Œë¦¿ ì‘ì„±</h2>

            <!-- í…œí”Œë¦¿ ì €ì¥ Form -->
            <form id="template-form" th:action="@{/checksheet/checksheetTemplateSave}" method="post">
                <!-- Hidden í•„ë“œ -->
                <input type="hidden" name="companyId" th:value="${checksheetTemplate.companyId}" />
                <input type="hidden" name="templateId" th:value="${checksheetTemplate.templateId}" />
                <input type="hidden" name="createBy" th:value="${checksheetTemplate.createBy}" />
                <input type="hidden" name="createDate" th:value="${checksheetTemplate.createDate}" />
                <input type="hidden" name="updateBy" th:value="${checksheetTemplate.updateBy}" />
                <input type="hidden" name="updateDate" th:value="${checksheetTemplate.updateDate}" />

                <div class="mb-4">
                    <label class="block font-medium text-gray-700 mb-1">í…œí”Œë¦¿ ì´ë¦„</label>
                    <input type="text" name="templateName" required
                        class="w-full border border-gray-300 rounded px-3 py-2"
                        th:value="${checksheetTemplate.templateName}" />
                </div>

                <!-- JSON ì €ì¥ìš© textarea (ê¸°ì¡´ í…œí”Œë¦¿ ë‚´ìš© í¬í•¨) -->
                <textarea id="form-template" name="templateJson" hidden
                    th:text="${checksheetTemplate.templateJson}"></textarea>

                <div class="mt-6 flex justify-end">
                    <button type="submit" onclick="return saveTemplate()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
                        ğŸ’¾ ì €ì¥
                    </button>
                </div>
            </form>

            <!-- FormBuilder ì˜ì—­ (form íƒœê·¸ ë°–ì— ë°°ì¹˜) -->
            <div class="mt-6">
                <!-- ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ë„êµ¬ ëª¨ìŒ -->
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                    <h4 class="font-medium text-blue-800 mb-2">ğŸ¨ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ë„êµ¬</h4>
                    <p class="text-sm text-blue-600 mb-3">
                        <strong>ğŸ“‹ ê·¸ë¦¬ë“œ ë°°ì¹˜ ë°©ì‹:</strong><br />
                        â€¢ <strong>3ì—´ ê·¸ë¦¬ë“œ = ê°€ë¡œë¡œ ë‚˜ë€íˆ 3ê°œ ë°°ì¹˜</strong> (ì˜†ìœ¼ë¡œ ìŒ“ì„)<br />
                        â€¢ ì‚¬ìš©ë²•: 1) í•„ë“œë“¤ì„ ë¨¼ì € ì¶”ê°€ â†’ 2) ê·¸ë¦¬ë“œë¡œ ë¬¶ì„ í•„ë“œë“¤ì„ Ctrl+í´ë¦­ìœ¼ë¡œ ì„ íƒ â†’ 3) ê·¸ë¦¬ë“œ ë²„íŠ¼ í´ë¦­
                    </p>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" onclick="applyGridToSelected(2)"
                            class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                            ğŸ“Š ì„ íƒí•œ í•„ë“œë¥¼ 2ì—´ë¡œ ë°°ì¹˜ (ê°€ë¡œ 2ê°œ)
                        </button>
                        <button type="button" onclick="applyGridToSelected(3)"
                            class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                            ğŸ“Š ì„ íƒí•œ í•„ë“œë¥¼ 3ì—´ë¡œ ë°°ì¹˜ (ê°€ë¡œ 3ê°œ)
                        </button>
                        <button type="button" onclick="applyGridToSelected(4)"
                            class="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                            ğŸ“Š ì„ íƒí•œ í•„ë“œë¥¼ 4ì—´ë¡œ ë°°ì¹˜ (ê°€ë¡œ 4ê°œ)
                        </button>
                        <button type="button" onclick="clearAllGrids()"
                            class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                            ğŸ—‘ï¸ ëª¨ë“  ê·¸ë¦¬ë“œ ì œê±°
                        </button>
                    </div>
                </div>

                <!-- formBuilder í‘œì‹œ ì˜ì—­ -->
                <div id="form-builder"
                    class="border border-dashed border-gray-400 p-4 bg-gray-50 rounded min-h-[600px] overflow-auto">
                </div>

                <!-- í•˜ë‹¨ ë²„íŠ¼ -->
                <div class="mt-6 flex justify-between">
                    <a th:href="@{/checksheet/checksheetTemplateList}"
                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ§  í˜ì´ì§€ ì „ìš© JS ì˜ì—­ -->
    <th:block layout:fragment="page-js">
        <script>
            window.addEventListener('DOMContentLoaded', () => {
                // ê¸°ë³¸ formBuilder ì„¤ì • (ëª¨ë“  ê¸°ë³¸ ê¸°ëŠ¥ ìœ ì§€)
                const formBuilder = $('#form-builder').formBuilder({
                    // ì–¸ì–´ íŒŒì¼ ê²½ë¡œ ìˆ˜ì • (ì‹¤ì œ ì¡´ì¬í•˜ëŠ” íŒŒì¼ ì‚¬ìš©)
                    i18n: {
                        locale: 'en-US',
                        location: '/assets/lang/'
                    }
                });

                // ê¸°ì¡´ JSON ê°’ ìˆìœ¼ë©´ ë¡œë”©
                const existingJson = document.getElementById("form-template").value;
                if (existingJson) {
                    formBuilder.promise.then(fb => {
                        fb.actions.setData(existingJson);
                    });
                }

                window.saveTemplate = function () {
                    // FormBuilderì—ì„œ JSON ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const json = formBuilder.actions.getData('json');
                    document.getElementById("form-template").value = json;

                    // Form ìˆ˜ë™ ì œì¶œ
                    document.getElementById("template-form").submit();
                    return false; // ê¸°ë³¸ ì´ë²¤íŠ¸ ë°©ì§€
                };

                // ê°„ë‹¨í•œ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ë„êµ¬ í•¨ìˆ˜ë“¤
                window.applyGridToSelected = function (columns) {
                    // í˜„ì¬ ì„ íƒëœ í•„ë“œë“¤ ì°¾ê¸° (selected í´ë˜ìŠ¤ë§Œ ì‚¬ìš©)
                    const selectedFields = $('#form-builder .fld-wrap.selected');

                    if (selectedFields.length === 0) {
                        showNotification('âŒ ê·¸ë¦¬ë“œë¡œ ë¬¶ì„ í•„ë“œë“¤ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!');
                        alert('ê·¸ë¦¬ë“œë¡œ ë¬¶ì„ í•„ë“œë“¤ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.\n\nì‚¬ìš©ë²•:\n1) ì²« ë²ˆì§¸ í•„ë“œ í´ë¦­\n2) Ctrl+í´ë¦­ìœ¼ë¡œ ì¶”ê°€ í•„ë“œ ì„ íƒ (íŒŒë€ìƒ‰ í…Œë‘ë¦¬ í‘œì‹œ)\n3) ê·¸ë¦¬ë“œ ë²„íŠ¼ í´ë¦­');
                        return;
                    }

                    // ì„ íƒëœ í•„ë“œë“¤ì„ ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆë¡œ ê°ì‹¸ê¸°
                    if (selectedFields.length > 1) {
                        const wrapper = $(`<div class="grid-${columns}-columns grid-container"></div>`);
                        selectedFields.first().before(wrapper);
                        selectedFields.appendTo(wrapper);

                        // ì„ íƒ ìƒíƒœ í•´ì œ
                        selectedFields.removeClass('selected');

                        showNotification(`âœ… ${selectedFields.length}ê°œ í•„ë“œê°€ ${columns}ì—´ ê·¸ë¦¬ë“œë¡œ ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    } else {
                        showNotification('âŒ ê·¸ë¦¬ë“œë¡œ ë¬¶ìœ¼ë ¤ë©´ ìµœì†Œ 2ê°œ ì´ìƒì˜ í•„ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                        alert('ê·¸ë¦¬ë“œë¡œ ë¬¶ìœ¼ë ¤ë©´ ìµœì†Œ 2ê°œ ì´ìƒì˜ í•„ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    }
                };

                window.clearAllGrids = function () {
                    if (confirm('ëª¨ë“  ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        // ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ í•´ì œ
                        $('#form-builder .grid-container').each(function () {
                            $(this).children().unwrap();
                        });
                        showNotification('âœ… ëª¨ë“  ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }
                };

                window.showNotification = function (message) {
                    // ê°„ë‹¨í•œ ì•Œë¦¼ í‘œì‹œ
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50';
                    notification.textContent = message;
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                };

                // í•„ë“œ ì„ íƒì„ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (formBuilder ë¡œë”© í›„ ì ìš©)
                formBuilder.promise.then(fb => {
                    // í•„ë“œ í´ë¦­ ì‹œ ì„ íƒ ìƒíƒœ í† ê¸€
                    $(document).on('click', '#form-builder .fld-wrap', function (e) {
                        if (e.ctrlKey || e.metaKey) { // Ctrl ë˜ëŠ” Cmd(Mac) í‚¤
                            $(this).toggleClass('selected');
                            e.preventDefault();
                            e.stopPropagation();

                            // ì„ íƒëœ í•„ë“œ ìˆ˜ í‘œì‹œ
                            const selectedCount = $('#form-builder .fld-wrap.selected').length;
                            showNotification(`${selectedCount}ê°œ í•„ë“œê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        } else {
                            // ë‹¨ì¼ ì„ íƒ
                            $('#form-builder .fld-wrap').removeClass('selected');
                            $(this).addClass('selected');
                        }
                    });

                    // ì„ íƒ í•´ì œë¥¼ ìœ„í•œ ë°°ê²½ í´ë¦­
                    $(document).on('click', '#form-builder', function (e) {
                        if ($(e.target).closest('.fld-wrap').length === 0) {
                            $('#form-builder .fld-wrap').removeClass('selected');
                        }
                    });
                });
            });
        </script>

        <!-- ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒì„ ìœ„í•œ CSS -->
        <style>
            /* í•„ë“œ ì„ íƒ í‘œì‹œ */
            #form-builder .fld-wrap.selected {
                background-color: #e3f2fd !important;
                border: 2px solid #2196f3 !important;
                box-shadow: 0 0 5px rgba(33, 150, 243, 0.5);
            }

            /* ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ */
            .grid-container {
                margin: 10px 0;
                padding: 10px;
                border: 2px dashed #007bff;
                border-radius: 8px;
                background-color: #f8f9ff;
            }

            /* 2ì—´ ê·¸ë¦¬ë“œ */
            .grid-2-columns {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            /* 3ì—´ ê·¸ë¦¬ë“œ */
            .grid-3-columns {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 15px;
            }

            /* 4ì—´ ê·¸ë¦¬ë“œ */
            .grid-4-columns {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }

            /* ê·¸ë¦¬ë“œ ë‚´ë¶€ í•„ë“œ ìŠ¤íƒ€ì¼ */
            .grid-container .fld-wrap {
                background: white;
                border-radius: 5px;
                padding: 10px;
                border: 1px solid #ddd;
            }

            /* í–‰ ì»´í¬ë„ŒíŠ¸ */
            .form-render .form-grid-row {
                width: 100%;
                border-bottom: 2px solid #007bff;
                margin: 20px 0 10px 0;
                padding-bottom: 5px;
            }

            /* ë°˜ì‘í˜• ê·¸ë¦¬ë“œ */
            @media (max-width: 768px) {

                .grid-2-columns,
                .grid-3-columns,
                .grid-4-columns {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </th:block>
</body>

</html>