<!-- 파일 목록 조회 프래그먼트 (조회만) -->
<div th:fragment="fileListFragment(companyId, fileGroupId)" th:id="'fileListComponent_' + ${fileGroupId}"
    class="file-list-component">

    <!-- Hidden Fields -->
    <input type="hidden" th:id="'companyId_' + ${fileGroupId}" th:value="${companyId}" />
    <input type="hidden" th:id="'fileGroupId_' + ${fileGroupId}" th:value="${fileGroupId != null ? fileGroupId : ''}" />

    <!-- File List -->
    <div th:id="'fileList_' + ${fileGroupId}" style="margin-top: 15px;">
        <div th:id="'noFiles_' + ${fileGroupId}"
            style="text-align: center; color: #666; padding: 20px; border: 1px dashed #ccc; border-radius: 4px; background-color: #f9f9f9;">
            첨부된 파일이 없습니다.
        </div>
    </div>

    <!-- JavaScript -->
    <script th:inline="javascript">
        // 파일 목록 조회 관련 JavaScript 함수들
        function loadFileList(fileGroupId) {
            if (!fileGroupId || fileGroupId.trim() === '') {
                return;
            }

            // 기존 파일 목록 초기화
            const fileList = document.getElementById('fileList_' + fileGroupId);
            const noFilesDiv = document.getElementById('noFiles_' + fileGroupId);

            // 기존 파일 항목들 제거 (첫 번째 자식인 "파일이 없습니다" 메시지 제외)
            while (fileList.children.length > 1) {
                fileList.removeChild(fileList.lastChild);
            }

            fetch('/file/list/' + fileGroupId)
                .then(response => response.json())
                .then(files => {
                    if (files && files.length > 0) {
                        files.forEach(file => {
                            addFileToList(fileGroupId, file);
                        });
                    } else {
                        // 파일이 없으면 "파일이 없습니다" 메시지 표시
                        if (noFilesDiv) {
                            noFilesDiv.style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                    // 에러 발생 시에도 "파일이 없습니다" 메시지 표시
                    if (noFilesDiv) {
                        noFilesDiv.style.display = 'block';
                    }
                });
        }

        function addFileToList(fileGroupId, fileData) {
            const fileList = document.getElementById('fileList_' + fileGroupId);
            const noFilesDiv = document.getElementById('noFiles_' + fileGroupId);

            // "파일이 없습니다" 메시지 숨기기
            if (noFilesDiv) {
                noFilesDiv.style.display = 'none';
            }

            const fileItem = document.createElement('div');
            fileItem.setAttribute('data-file-id', fileData.fileId);
            fileItem.setAttribute('data-file-size', fileData.fileSize);
            fileItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0; background-color: white;';

            const fileSize = formatFileSize(fileData.fileSize);

            fileItem.innerHTML = `
                <div style="flex: 1; margin-right: 10px;">${fileData.originalFileName}</div>
                <div style="color: #666; font-size: 0.9em; margin-right: 10px;">${fileSize}</div>
            `;

            fileList.appendChild(fileItem);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 즉시 실행 함수로 파일 목록 로드
        (function () {
            // 이미 초기화된 컴포넌트인지 확인하는 Set
            const initializedComponents = new Set();

            function initializeFileList() {
                // 모든 파일 목록 컴포넌트에 대해 기존 파일 로드
                const fileGroupIds = document.querySelectorAll('[id^="fileGroupId_"]');
                fileGroupIds.forEach(element => {
                    const fileGroupId = element.value;

                    // 이미 초기화된 컴포넌트는 건너뛰기
                    if (initializedComponents.has(fileGroupId)) {
                        return;
                    }

                    // 기존 파일 목록 로드
                    if (fileGroupId && fileGroupId.trim() !== '') {
                        loadFileList(fileGroupId);
                        // 초기화 완료 표시
                        initializedComponents.add(fileGroupId);
                    }
                });
            }

            // DOM이 준비되면 즉시 실행
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeFileList);
            } else {
                // DOM이 이미 로드된 경우 즉시 실행
                initializeFileList();
            }
        })();
    </script>
</div>